$rdf=function(){if(typeof tabulator!="undefined"&&typeof tabulator.isExtension=="undefined")tabulator.isExtension=false;if(typeof e=="undefined"){var e={}}else{return e;throw"Internal error: RDF libray has already been loaded: $rdf already exists"}if(e.log!=undefined){throw"Internal Error: $rdf.log already defined,  util.js: "+e.log}e.log={debug:function(e){return},warn:function(e){return},info:function(e){return},error:function(e){return},success:function(e){return},msg:function(e){return}};e.Util={output:function(e){var t=document.createElement("div");t.textContent=e;document.body.appendChild(t)},callbackify:function(e,t){e.callbacks={};for(var n=t.length-1;n>=0;n--){e.callbacks[t[n]]=[]}e.addHook=function(t){if(!e.callbacks[t])e.callbacks[t]=[]};e.addCallback=function(t,n){e.callbacks[t].push(n)};e.removeCallback=function(t,n){for(var r=0;r<e.callbacks[t].length;r++){if(e.callbacks[t][r].name==n){e.callbacks[t].splice(r,1);return true}}return false};e.insertCallback=function(t,n){e.callbacks[t].unshift(n)};e.fireCallbacks=function(t,n){var r=[];var i=[];var s=e.callbacks[t].length;for(var o=s-1;o>=0;o--){if(e.callbacks[t][o].apply(e,n)){r.push(e.callbacks[t][o])}}for(var o=r.length-1;o>=0;o--){i.push(r[o])}for(var o=s;o<e.callbacks[t].length;o++){i.push(e.callbacks[t][o])}e.callbacks[t]=i}},XMLHTTPFactory:function(){if(typeof module!="undefined"&&module&&module.exports){var e=require("XMLHttpRequest").XMLHttpRequest;return new e}if(typeof tabulator!="undefined"&&tabulator.isExtension){return Components.classes["@mozilla.org/xmlextras/xmlhttprequest;1"].createInstance().QueryInterface(Components.interfaces.nsIXMLHttpRequest)}else if(window.XMLHttpRequest){return new window.XMLHttpRequest}else if(window.ActiveXObject){try{return new ActiveXObject("Msxml2.XMLHTTP")}catch(t){return new ActiveXObject("Microsoft.XMLHTTP")}}else{return false}},DOMParserFactory:function(){if(tabulator&&tabulator.isExtension){return Components.classes["@mozilla.org/xmlextras/domparser;1"].getService(Components.interfaces.nsIDOMParser)}else if(window.DOMParser){return new DOMParser}else if(window.ActiveXObject){return new ActiveXObject("Microsoft.XMLDOM")}else{return false}},getHTTPHeaders:function(e){var t=e.getAllResponseHeaders().split("\n");var n={};var r=undefined;for(var i=0;i<t.length;i++){if(t[i].length>0){var s=t[i].split(": ");if(typeof s[1]=="undefined"){n[r]+="\n"+s[0]}else{r=s[0].toLowerCase();n[r]=s[1]}}}return n},dtstamp:function(){var e=new Date;var t=e.getYear()+1900;var n=e.getMonth()+1;var r=e.getDate();var i=e.getUTCHours();var s=e.getUTCMinutes();var o=e.getSeconds();if(n<10)n="0"+n;if(r<10)r="0"+r;if(i<10)i="0"+i;if(s<10)s="0"+s;if(o<10)o="0"+o;return t+"-"+n+"-"+r+"T"+i+":"+s+":"+o+"Z"},enablePrivilege:typeof netscape!="undefined"&&typeof netscape.security.PrivilegeManager!="undefined"&&netscape.security.PrivilegeManager.enablePrivilege||function(){return},disablePrivilege:typeof netscape!="undefined"&&typeof netscape.security.PrivilegeManager!="undefined"&&netscape.security.PrivilegeManager.disablePrivilege||function(){return},RDFArrayRemove:function(e,t){for(var n=0;n<e.length;n++){if(e[n].subject.sameTerm(t.subject)&&e[n].predicate.sameTerm(t.predicate)&&e[n].object.sameTerm(t.object)&&e[n].why.sameTerm(t.why)){e.splice(n,1);return}}throw"RDFArrayRemove: Array did not contain "+t},string_startswith:function(e,t){return e.slice(0,t.length)==t},AJAR_handleNewTerm:function(t,n,r){var i=null;if(typeof t.sf!="undefined"){i=t.sf}else{return}if(n.termType!="symbol")return;var s=e.Util.uri.docpart(n.uri);var o;if(n.uri.indexOf("#")<0){if(e.Util.string_startswith(n.uri,"http://dbpedia.org/resource/Category:"))return;if(e.Util.string_startswith(n.uri,"http://purl.org/dc/elements/1.1/")||e.Util.string_startswith(n.uri,"http://purl.org/dc/terms/")){o="http://dublincore.org/2005/06/13/dcq"}else if(e.Util.string_startswith(n.uri,"http://xmlns.com/wot/0.1/")){o="http://xmlns.com/wot/0.1/index.rdf"}else if(e.Util.string_startswith(n.uri,"http://web.resource.org/cc/")){o="http://web.resource.org/cc/schema.rdf"}}if(o){s=o}if(i&&i.getState(s)!="unrequested")return;if(o){e.log.warn("Assuming server still broken, faking redirect of <"+n.uri+"> to <"+s+">")}i.requestURI(s,r)},ArrayIndexOf:function(e,t,n){n||(n=0);var r=e.length;if(n<0)n=r+n;for(;n<r;n++)if(e[n]===t)return n;return-1}};e.Util.parseXML=function(e){var t;if(typeof tabulator!="undefined"&&tabulator.isExtension){t=Components.classes["@mozilla.org/xmlextras/domparser;1"].getService(Components.interfaces.nsIDOMParser)}else if(typeof module!="undefined"){var n=require("jsdom");var r=n.jsdom(e,undefined,{});return r}else{t=new DOMParser}return t.parseFromString(e,"application/xml")};e.Util.string={template:function(e,t){var n=e.split("%s");var r="";for(var i=0;i<t.length;i++){t[i]+="";r+=n[i]+t[i]}return r+n.slice(t.length).join()}};e.Util.extend=function(){var e=arguments[0]||{},t=1,n=arguments.length,r=false,i,s,o,u;if(typeof e==="boolean"){r=e;e=arguments[1]||{};t=2}if(typeof e!=="object"&&!jQuery.isFunction(e)){e={}}if(n===t){e=this;--t}for(;t<n;t++){if((i=arguments[t])!=null){for(s in i){o=e[s];u=i[s];if(e===u){continue}if(r&&u&&typeof u==="object"&&!u.nodeType){var a;if(o){a=o}else if(jQuery.isArray(u)){a=[]}else if(jQuery.isObject(u)){a={}}else{a=u}e[s]=jQuery.extend(r,a,u)}else if(u!==undefined){e[s]=u}}}}return e};var e,t,r,o,u,a,f,l={}.hasOwnProperty;if(typeof e==="undefined"||e===null){e={}}if((u=e.Util)==null){e.Util={}}e.Util.uri=function(){function t(){}t.join=function(e,t){var n,r,i,s,o,u,a;r=t.indexOf("#");if(r>0){t=t.slice(0,r)}if(e.length===0){return t}if(e.indexOf("#")===0){return t+e}o=e.indexOf(":");if(o>=0){return e}n=t.indexOf(":");if(t.length===0){return e}if(n<0){alert("Invalid base: "+t+" in join with given: "+e);return e}i=t.slice(0,n+1||9e9);if(e.indexOf("//")===0){return i+e}if(t.indexOf("//",n)===n+1){s=t.indexOf("/",n+3);if(s<0){if(t.length-n-3>0){return t+"/"+e}else{return i+e}}}else{s=t.indexOf("/",n+1);if(s<0){if(t.length-n-1>0){return t+"/"+e}else{return i+e}}}if(e.indexOf("/")===0){return t.slice(0,s)+e}a=t.slice(s);u=a.lastIndexOf("/");if(u<0){return i+e}if(u>=0&&u<a.length-1){a=a.slice(0,u+1||9e9)}a+=e;while(a.match(/[^\/]*\/\.\.\//)){a=a.replace(/[^\/]*\/\.\.\//,"")}a=a.replace(/\.\//g,"");a=a.replace(/\/\.$/,"/");return t.slice(0,s)+a};if(typeof tabulator!=="undefined"&&tabulator!==null?tabulator.isExtension:void 0){t.join2=function(e,t){var n,r;r=Components.classes["@mozilla.org/network/io-service;1"].getService(Components.interfaces.nsIIOService);n=r.newURI(t,null,null);return r.newURI(n.resolve(e),null,null).spec}}else{t.join2=t.join}t.commonHost=new RegExp("^[-_a-zA-Z0-9.]+:(//[^/]*)?/[^/]*$");t.hostpart=function(e){var t;t=/[^\/]*\/\/([^\/]*)\//.exec(e);if(t){return t[1]}else{return""}};t.refTo=function(t,n){var r,i,s,o,u,a,f,l,c,h,p,d,v;if(!t){return n}if(t===n){return""}for(i=l=0,p=n.length;l<p;i=++l){r=n[i];if(r!==t[i]){break}}if(t.slice(0,i).match(e.Util.uri.commonHost)){o=n.indexOf("//");if(o<0){o=-2}u=n.indexOf("/",o+2);if(n[u+1]!=="/"&&t[u+1]!=="/"&&n.slice(0,u)===t.slice(0,u)){return n.slice(u)}}if(n[i]==="#"&&t.length===i){return n.slice(i)}while(i>0&&n[i-1]!=="/"){i--}if(i<3){return n}if(t.indexOf("//",i-2)>0||n.indexOf("//",i-2)>0){return n}if(t.indexOf(":",i)>0){return n}a=0;v=t.slice(i);for(c=0,d=v.length;c<d;c++){r=v[c];if(r==="/"){a++}}if(a===0&&i<n.length&&n[i]==="#"){return"./"+n.slice(i)}if(a===0&&i===n.length){return"./"}f="";if(a>0){for(s=h=1;1<=a?h<=a:h>=a;s=1<=a?++h:--h){f+="../"}}return f+n.slice(i)};t.docpart=function(e){var t;t=e.indexOf("#");if(t<0){return e}else{return e.slice(0,t)}};t.document=function(n){return e.sym(t.docpart(n.uri))};t.protocol=function(e){var t;t=e.indexOf(":");if(t<0){return null}else{return e.slice(0,t)}};return t}.call(this);if((typeof module!=="undefined"&&module!==null?module.exports:void 0)!=null){if((a=(o=module.exports).Util)==null){o.Util={}}f=e.Util;for(t in f){if(!l.call(f,t))continue;r=f[t];module.exports.Util[t]=r}}var e,t,r,l={}.hasOwnProperty,c=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++){if(t in this&&this[t]===e)return t}return-1};if(typeof e==="undefined"||e===null){e={}}e.Empty=function(){function e(){}e.prototype.termType="empty";e.prototype.toString=function(){return"()"};e.prototype.toNT=e.prototype.toString;return e}();e.Symbol=function(){function e(e){this.uri=e;this.value=this.uri}e.prototype.termType="symbol";e.prototype.toString=function(){return"<"+this.uri+">"};e.prototype.toNT=e.prototype.toString;e.prototype.sameTerm=function(e){if(!e){return false}return this.termType===e.termType&&this.uri===e.uri};e.prototype.compareTerm=function(e){if(this.classOrder<e.classOrder){return-1}if(this.classOrder>e.classOrder){return+1}if(this.uri<e.uri){return-1}if(this.uri>e.uri){return+1}return 0};e.prototype.XSDboolean=new e("http://www.w3.org/2001/XMLSchema#boolean");e.prototype.XSDdecimal=new e("http://www.w3.org/2001/XMLSchema#decimal");e.prototype.XSDfloat=new e("http://www.w3.org/2001/XMLSchema#float");e.prototype.XSDinteger=new e("http://www.w3.org/2001/XMLSchema#integer");e.prototype.XSDdateTime=new e("http://www.w3.org/2001/XMLSchema#dateTime");e.prototype.integer=new e("http://www.w3.org/2001/XMLSchema#integer");return e}();if(e.NextId!=null){e.log.error("Attempt to re-zero existing blank node id counter at "+e.NextId)}else{e.NextId=0}e.NTAnonymousNodePrefix="_:n";e.BlankNode=function(){function t(t){this.id=e.NextId++;this.value=t?t:this.id.toString()}t.prototype.termType="bnode";t.prototype.toNT=function(){return e.NTAnonymousNodePrefix+this.id};t.prototype.toString=t.prototype.toNT;t.prototype.sameTerm=function(e){if(!e){return false}return this.termType===e.termType&&this.id===e.id};t.prototype.compareTerm=function(e){if(this.classOrder<e.classOrder){return-1}if(this.classOrder>e.classOrder){return+1}if(this.id<e.id){return-1}if(this.id>e.id){return+1}return 0};return t}();e.Literal=function(){function e(e,t,n){var r,i;this.value=e;this.lang=t;this.datatype=n;if((r=this.lang)==null){this.lang=void 0}if((i=this.datatype)==null){this.datatype=void 0}}e.prototype.termType="literal";e.prototype.toString=function(){return""+this.value};e.prototype.toNT=function(){var e;e=this.value;if(typeof e===!"string"){if(typeof e==="number"){return""+e}throw Error("Value of RDF literal is not string: "+e)}e=e.replace(/\\/g,"\\\\");e=e.replace(/\"/g,'\\"');e=e.replace(/\n/g,"\\n");e='"'+e+'"';if(this.datatype){e+="^^"+this.datatype.toNT()}if(this.lang){e+="@"+this.lang}return e};e.prototype.sameTerm=function(e){if(!e){return false}return this.termType===e.termType&&this.value===e.value&&this.lang===e.lang&&(!this.datatype&&!e.datatype||this.datatype&&this.datatype.sameTerm(e.datatype))};e.prototype.compareTerm=function(e){if(this.classOrder<e.classOrder){return-1}if(this.classOrder>e.classOrder){return+1}if(this.value<e.value){return-1}if(this.value>e.value){return+1}return 0};return e}();e.Collection=function(){function t(){this.id=e.NextId++;this.elements=[];this.closed=false}t.prototype.termType="collection";t.prototype.toNT=function(){return e.NTAnonymousNodePrefix+this.id};t.prototype.toString=function(){return"("+this.elements.join(" ")+")"};t.prototype.append=function(e){return this.elements.push(e)};t.prototype.unshift=function(e){return this.elements.unshift(e)};t.prototype.shift=function(){return this.elements.shift()};t.prototype.close=function(){return this.closed=true};return t}();e.Collection.prototype.sameTerm=e.BlankNode.prototype.sameTerm;e.Collection.prototype.compareTerm=e.BlankNode.prototype.compareTerm;e.term=function(t){var n,r,i,s,o,u,a;switch(typeof t){case"object":if(t instanceof Date){n=function(e){return(""+(100+e)).slice(1,3)};s=""+t.getUTCFullYear()+"-"+n(t.getUTCMonth()+1)(+"-"+n(t.getUTCDate())+"T"+n(t.getUTCHours())+":"+n(t.getUTCMinutes())+":"+n(t.getUTCSeconds())+"Z");return new e.Literal(s,void 0,e.Symbol.prototype.XSDdateTime)}else if(t instanceof Array){o=new e.Collection;for(u=0,a=t.length;u<a;u++){i=t[u];o.append(e.term(i))}return o}return t;case"string":return new e.Literal(t);case"number":if((""+t).indexOf("e")>=0){r=e.Symbol.prototype.XSDfloat}else if((""+t).indexOf(".")>=0){r=e.Symbol.prototype.XSDdecimal}else{r=e.Symbol.prototype.XSDinteger}return new e.Literal(""+t,void 0,r);case"boolean":return new e.Literal(t?"1":"0",void 0,e.Symbol.prototype.XSDboolean);case"undefined":return void 0}throw"Can't make term from "+t+" of type "+typeof t};e.Statement=function(){function t(t,n,r,i){this.subject=e.term(t);this.predicate=e.term(n);this.object=e.term(r);if(i!=null){this.why=i}}t.prototype.toNT=function(){return[this.subject.toNT(),this.predicate.toNT(),this.object.toNT()].join(" ")+" ."};t.prototype.toString=t.prototype.toNT;return t}();e.st=function(t,n,r,i){return new e.Statement(t,n,r,i)};e.Formula=function(){function t(){this.statements=[];this.constraints=[];this.initBindings=[];this.optional=[]}t.prototype.termType="formula";t.prototype.toNT=function(){return"{"+this.statements.join("\n")+"}"};t.prototype.toString=t.prototype.toNT;t.prototype.add=function(t,n,r,i){return this.statements.push(new e.Statement(t,n,r,i))};t.prototype.sym=function(t,n){if(n!=null){throw"This feature (kb.sym with 2 args) is removed. Do not assume prefix mappings.";if(!e.ns[t]){throw"The prefix "+t+" is not set in the API"}t=e.ns[t]+n}return new e.Symbol(t)};t.prototype.literal=function(t,n,r){return new e.Literal(""+t,n,r)};t.prototype.bnode=function(t){return new e.BlankNode(t)};t.prototype.formula=function(){return new e.Formula};t.prototype.collection=function(){return new e.Collection};t.prototype.list=function(t){var n,r,i,s;r=new e.Collection;if(t){for(i=0,s=t.length;i<s;i++){n=t[i];r.append(n)}}return r};t.prototype.variable=function(t){return new e.Variable(t)};t.prototype.ns=function(t){return function(n){return new e.Symbol(t+(n!=null?n:""))}};t.prototype.fromNT=function(t){var n,r,i,s;switch(t[0]){case"<":return e.sym(t.slice(1,-1));case'"':i=void 0;n=void 0;r=t.lastIndexOf('"');if(r<t.length-1){if(t[r+1]==="@"){i=t.slice(r+2)}else if(t.slice(r+1,r+3)==="^^"){n=e.fromNT(t.slice(r+3))}else{throw"Can't convert string from NT: "+t}}t=t.slice(1,r);t=t.replace(/\\"/g,'"');t=t.replace(/\\n/g,"\n");t=t.replace(/\\\\/g,"\\");return e.lit(t,i,n);case"_":s=new e.BlankNode;s.id=parseInt(t.slice(3));e.NextId--;return s;case"?":return new e.Variable(t.slice(1))}throw"Can't convert from NT: "+t};t.prototype.sameTerm=function(e){if(!e){return false}return this.hashString()===e.hashString()};t.prototype.each=function(e,t,n,r){var i,s,o,u,a,f,l,c,h,p,d;s=[];o=this.statementsMatching(e,t,n,r,false);if(!(e!=null)){for(u=0,c=o.length;u<c;u++){i=o[u];s.push(i.subject)}}else if(!(t!=null)){for(a=0,h=o.length;a<h;a++){i=o[a];s.push(i.predicate)}}else if(!(n!=null)){for(f=0,p=o.length;f<p;f++){i=o[f];s.push(i.object)}}else if(!(r!=null)){for(l=0,d=o.length;l<d;l++){i=o[l];s.push(i.why)}}return s};t.prototype.any=function(e,t,n,r){var i;i=this.anyStatementMatching(e,t,n,r);if(!(i!=null)){return void 0}else if(!(e!=null)){return i.subject}else if(!(t!=null)){return i.predicate}else if(!(n!=null)){return i.object}return void 0};t.prototype.holds=function(e,t,n,r){var i;i=this.anyStatementMatching(e,t,n,r);return i!=null};t.prototype.holdsStatement=function(e){return this.holds(e.subject,e.predicate,e.object,e.why)};t.prototype.the=function(t,n,r,i){var s;s=this.any(t,n,r,i);if(s==null){e.log.error("No value found for the() {"+t+" "+n+" "+r+"}.")}return s};t.prototype.whether=function(e,t,n,r){return this.statementsMatching(e,t,n,r,false).length};t.prototype.transitiveClosure=function(e,t,n){var r,i,s,o,u,a,f,c,h,p;i={};r={};for(o in e){if(!l.call(e,o))continue;c=e[o];r[o]=c}while(true){f=function(){var e;for(e in r){if(!l.call(r,e))continue;return e}}();if(f==null){return i}a=n?this.each(void 0,t,this.fromNT(f)):this.each(this.fromNT(f),t);for(h=0,p=a.length;h<p;h++){s=a[h];u=s.toNT();if(u in i){continue}if(u in r){continue}r[u]=r[f]}i[f]=r[f];delete r[f]}};t.prototype.findMembersNT=function(e){var t,n,r,i,s,o,u,a,f,c,h,p,d,v,m,g,y,b,w,E,S;r={};r[e.toNT()]=true;t={};g=this.transitiveClosure(r,this.sym("http://www.w3.org/2000/01/rdf-schema#subClassOf"),true);for(s in g){if(!l.call(g,s))continue;y=this.statementsMatching(void 0,this.sym("http://www.w3.org/1999/02/22-rdf-syntax-ns#type"),this.fromNT(s));for(o=0,c=y.length;o<c;o++){i=y[o];t[i.subject.toNT()]=i}b=this.each(void 0,this.sym("http://www.w3.org/2000/01/rdf-schema#domain"),this.fromNT(s));for(u=0,h=b.length;u<h;u++){n=b[u];w=this.statementsMatching(void 0,n);for(a=0,p=w.length;a<p;a++){i=w[a];t[i.subject.toNT()]=i}}E=this.each(void 0,this.sym("http://www.w3.org/2000/01/rdf-schema#range"),this.fromNT(s));for(f=0,d=E.length;f<d;f++){n=E[f];S=this.statementsMatching(void 0,n);for(m=0,v=S.length;m<v;m++){i=S[m];t[i.object.toNT()]=i}}}return t};t.prototype.NTtoURI=function(e){var t,n,r;n={};for(t in e){if(!l.call(e,t))continue;r=e[t];if(t[0]==="<"){n[t.slice(1,-1)]=r}}return n};t.prototype.findTypeURIs=function(e){return this.NTtoURI(this.findTypesNT(e))};t.prototype.findMemberURIs=function(e){return this.NTtoURI(this.findMembersNT(e))};t.prototype.findTypesNT=function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g;r="http://www.w3.org/1999/02/22-rdf-syntax-ns#type";s=[];d=this.statementsMatching(e,void 0,void 0);for(o=0,l=d.length;o<l;o++){i=d[o];if(i.predicate.uri===r){s[i.object.toNT()]=i}else{v=this.each(i.predicate,this.sym("http://www.w3.org/2000/01/rdf-schema#domain"));for(u=0,c=v.length;u<c;u++){n=v[u];s[n.toNT()]=i}}}m=this.statementsMatching(void 0,void 0,e);for(a=0,h=m.length;a<h;a++){i=m[a];g=this.each(i.predicate,this.sym("http://www.w3.org/2000/01/rdf-schema#range"));for(f=0,p=g.length;f<p;f++){t=g[f];s[t.toNT()]=i}}return this.transitiveClosure(s,this.sym("http://www.w3.org/2000/01/rdf-schema#subClassOf"),false)};t.prototype.findSuperClassesNT=function(e){var t;t=[];t[e.toNT()]=true;return this.transitiveClosure(t,this.sym("http://www.w3.org/2000/01/rdf-schema#subClassOf"),false)};t.prototype.findSubClassesNT=function(e){var t;t=[];t[e.toNT()]=true;return this.transitiveClosure(t,this.sym("http://www.w3.org/2000/01/rdf-schema#subClassOf"),true)};t.prototype.topTypeURIs=function(e){var t,n,r,i,s,o,u,a;i=[];for(n in e){if(!l.call(e,n))continue;s=e[n];r=0;a=this.each(this.sym(n),this.sym("http://www.w3.org/2000/01/rdf-schema#subClassOf"));for(o=0,u=a.length;o<u;o++){t=a[o];if(t.uri!=="http://www.w3.org/2000/01/rdf-schema#Resource"){r++;break}}if(!r){i[n]=s}}if(i["http://www.w3.org/2000/01/rdf-schema#Resource"]){delete i["http://www.w3.org/2000/01/rdf-schema#Resource"]}if(i["http://www.w3.org/2002/07/owl#Thing"]){delete i["http://www.w3.org/2002/07/owl#Thing"]}return i};t.prototype.bottomTypeURIs=function(e){var t,n,r,i,s,o,u,a,f;t=[];for(i in e){if(!l.call(e,i))continue;o=e[i];s=this.each(void 0,this.sym("http://www.w3.org/2000/01/rdf-schema#subClassOf"),this.sym(i));n=true;for(u=0,a=s.length;u<a;u++){r=s[u];if(f=r.uri,c.call(e,f)>=0){n=false;break}}if(n){t[i]=o}}return t};return t}();e.sym=function(t){return new e.Symbol(t)};e.lit=e.Formula.prototype.literal;e.Namespace=e.Formula.prototype.ns;e.variable=e.Formula.prototype.variable;e.Variable=function(){function t(t){this.base="varid:";this.uri=e.Util.uri.join(t,this.base)}t.prototype.termType="variable";t.prototype.toNT=function(){if(this.uri.slice(0,this.base.length)===this.base){return"?"+this.uri.slice(this.base.length)}return"?"+this.uri};t.prototype.toString=t.prototype.toNT;t.prototype.hashString=t.prototype.toNT;t.prototype.sameTerm=function(e){if(!e){false}return this.termType===e.termType&&this.uri===e.uri};return t}();e.Literal.prototype.classOrder=1;e.Collection.prototype.classOrder=3;e.Formula.prototype.classOrder=4;e.Symbol.prototype.classOrder=5;e.BlankNode.prototype.classOrder=6;e.Variable.prototype.classOrder=7;e.fromNT=e.Formula.prototype.fromNT;e.graph=function(){return new e.IndexedFormula};if((typeof module!=="undefined"&&module!==null?module.exports:void 0)!=null){for(t in e){if(!l.call(e,t))continue;r=e[t];module.exports[t]=r}}e.RDFParser=function(t){var n={};n["ns"]={RDF:"http://www.w3.org/1999/02/22-rdf-syntax-ns#",RDFS:"http://www.w3.org/2000/01/rdf-schema#"};n["nodeType"]={ELEMENT:1,ATTRIBUTE:2,TEXT:3,CDATA_SECTION:4,ENTITY_REFERENCE:5,ENTITY:6,PROCESSING_INSTRUCTION:7,COMMENT:8,DOCUMENT:9,DOCUMENT_TYPE:10,DOCUMENT_FRAGMENT:11,NOTATION:12};this["frameFactory"]=function(t,r,i){return{NODE:1,ARC:2,parent:r,parser:t,store:t["store"],element:i,lastChild:0,base:null,lang:null,node:null,nodeType:null,listIndex:1,rdfid:null,datatype:null,collection:false,terminateFrame:function(){if(this["collection"]){this["node"]["close"]()}},addSymbol:function(t,n){n=e.Util.uri.join(n,this["base"]);this["node"]=this["store"]["sym"](n);this["nodeType"]=t},loadTriple:function(){if(this["parent"]["parent"]["collection"]){this["parent"]["parent"]["node"]["append"](this["node"])}else{this["store"]["add"](this["parent"]["parent"]["node"],this["parent"]["node"],this["node"],this["parser"]["why"])}if(this["parent"]["rdfid"]!=null){var t=this["store"]["sym"](e.Util.uri.join("#"+this["parent"]["rdfid"],this["base"]));this["store"]["add"](t,this["store"]["sym"](n["ns"]["RDF"]+"type"),this["store"]["sym"](n["ns"]["RDF"]+"Statement"),this["parser"]["why"]);this["store"]["add"](t,this["store"]["sym"](n["ns"]["RDF"]+"subject"),this["parent"]["parent"]["node"],this["parser"]["why"]);this["store"]["add"](t,this["store"]["sym"](n["ns"]["RDF"]+"predicate"),this["parent"]["node"],this["parser"]["why"]);this["store"]["add"](t,this["store"]["sym"](n["ns"]["RDF"]+"object"),this["node"],this["parser"]["why"])}},isTripleToLoad:function(){return this["parent"]!=null&&this["parent"]["parent"]!=null&&this["nodeType"]==this["NODE"]&&this["parent"]["nodeType"]==this["ARC"]&&this["parent"]["parent"]["nodeType"]==this["NODE"]},addNode:function(e){this["addSymbol"](this["NODE"],e);if(this["isTripleToLoad"]()){this["loadTriple"]()}},addCollection:function(){this["nodeType"]=this["NODE"];this["node"]=this["store"]["collection"]();this["collection"]=true;if(this["isTripleToLoad"]()){this["loadTriple"]()}},addCollectionArc:function(){this["nodeType"]=this["ARC"]},addBNode:function(e){if(e!=null){if(this["parser"]["bnodes"][e]!=null){this["node"]=this["parser"]["bnodes"][e]}else{this["node"]=this["parser"]["bnodes"][e]=this["store"]["bnode"]()}}else{this["node"]=this["store"]["bnode"]()}this["nodeType"]=this["NODE"];if(this["isTripleToLoad"]()){this["loadTriple"]()}},addArc:function(e){if(e==n["ns"]["RDF"]+"li"){e=n["ns"]["RDF"]+"_"+this["parent"]["listIndex"]++}this["addSymbol"](this["ARC"],e)},addLiteral:function(e){if(this["parent"]["datatype"]){this["node"]=this["store"]["literal"](e,"",this["store"]["sym"](this["parent"]["datatype"]))}else{this["node"]=this["store"]["literal"](e,this["lang"])}this["nodeType"]=this["NODE"];if(this["isTripleToLoad"]()){this["loadTriple"]()}}}};this["getAttributeNodeNS"]=function(e,t,n){var r=null;if(e.getAttributeNodeNS){r=e.getAttributeNodeNS(t,n)}else{var i=e.attributes;var s,o;for(var u=0;u<i.length;++u){s=i[u];if(s.namespaceURI==t){o=s.prefix?s.prefix+":"+n:n;if(o==s.nodeName){r=s;break}}}}return r};this["store"]=t;this["bnodes"]={};this["why"]=null;this["reify"]=false;this["parse"]=function(e,t,r){var i=e["childNodes"];this["cleanParser"]();if(e["nodeType"]==n["nodeType"]["DOCUMENT"]){for(var s=0;s<i["length"];s++){if(i[s]["nodeType"]==n["nodeType"]["ELEMENT"]){var o=i[s];break}}}else if(e["nodeType"]==n["nodeType"]["ELEMENT"]){var o=e}else{throw new Error("RDFParser: can't find root in "+t+". Halting. ");return false}this["why"]=r;var u=this["frameFactory"](this);this["base"]=t;u["base"]=t;u["lang"]="";this["parseDOM"](this["buildFrame"](u,o));return true};this["parseDOM"]=function(t){var r=function(e){var t="";if(e["namespaceURI"]==null){throw new Error("RDF/XML syntax error: No namespace for "+e["localName"]+" in "+this.base)}if(e["namespaceURI"]){t=t+e["namespaceURI"]}if(e["localName"]){t=t+e["localName"]}else if(e["nodeName"]){if(e["nodeName"].indexOf(":")>=0)t=t+e["nodeName"].split(":")[1];else t=t+e["nodeName"]}return t}.bind(this);var i=true;while(t["parent"]){var s=t["element"];var o=s["attributes"];if(s["nodeType"]==n["nodeType"]["TEXT"]||s["nodeType"]==n["nodeType"]["CDATA_SECTION"]){t["addLiteral"](s["nodeValue"])}else if(r(s)!=n["ns"]["RDF"]+"RDF"){if(t["parent"]&&t["parent"]["collection"]){t["addCollectionArc"]();t=this["buildFrame"](t,t["element"]);t["parent"]["element"]=null}if(!t["parent"]||!t["parent"]["nodeType"]||t["parent"]["nodeType"]==t["ARC"]){var u=this["getAttributeNodeNS"](s,n["ns"]["RDF"],"about");var a=this["getAttributeNodeNS"](s,n["ns"]["RDF"],"ID");if(u&&a){throw new Error("RDFParser: "+s["nodeName"]+" has both rdf:id and rdf:about."+" Halting. Only one of these"+" properties may be specified on a"+" node.")}if(u==null&&a){t["addNode"]("#"+a["nodeValue"]);s["removeAttributeNode"](a)}else if(u==null&&a==null){var f=this["getAttributeNodeNS"](s,n["ns"]["RDF"],"nodeID");if(f){t["addBNode"](f["nodeValue"]);s["removeAttributeNode"](f)}else{t["addBNode"]()}}else{t["addNode"](u["nodeValue"]);s["removeAttributeNode"](u)}var l=this["getAttributeNodeNS"](s,n["ns"]["RDF"],"type");if(n["ns"]["RDF"]+"Description"!=r(s)){l={nodeValue:r(s)}}if(l!=null){this["store"]["add"](t["node"],this["store"]["sym"](n["ns"]["RDF"]+"type"),this["store"]["sym"](e.Util.uri.join(l["nodeValue"],t["base"])),this["why"]);if(l["nodeName"]){s["removeAttributeNode"](l)}}for(var c=o["length"]-1;c>=0;c--){this["store"]["add"](t["node"],this["store"]["sym"](r(o[c])),this["store"]["literal"](o[c]["nodeValue"],t["lang"]),this["why"])}}else{t["addArc"](r(s));if(this["reify"]){var a=this["getAttributeNodeNS"](s,n["ns"]["RDF"],"ID");if(a){t["rdfid"]=a["nodeValue"];s["removeAttributeNode"](a)}}var h=this["getAttributeNodeNS"](s,n["ns"]["RDF"],"parseType");var p=this["getAttributeNodeNS"](s,n["ns"]["RDF"],"datatype");if(p){t["datatype"]=p["nodeValue"];s["removeAttributeNode"](p)}if(h){var d=h["nodeValue"];if(d=="Literal"){t["datatype"]=n["ns"]["RDF"]+"XMLLiteral";t=this["buildFrame"](t);t["addLiteral"](s);i=false}else if(d=="Resource"){t=this["buildFrame"](t,t["element"]);t["parent"]["element"]=null;t["addBNode"]()}else if(d=="Collection"){t=this["buildFrame"](t,t["element"]);t["parent"]["element"]=null;t["addCollection"]()}s["removeAttributeNode"](h)}if(o["length"]!=0){var v=this["getAttributeNodeNS"](s,n["ns"]["RDF"],"resource");var f=this["getAttributeNodeNS"](s,n["ns"]["RDF"],"nodeID");t=this["buildFrame"](t);if(v){t["addNode"](v["nodeValue"]);s["removeAttributeNode"](v)}else{if(f){t["addBNode"](f["nodeValue"]);s["removeAttributeNode"](f)}else{t["addBNode"]()}}for(var c=o["length"]-1;c>=0;c--){var m=this["buildFrame"](t);m["addArc"](r(o[c]));if(r(o[c])==n["ns"]["RDF"]+"type"){this["buildFrame"](m)["addNode"](o[c]["nodeValue"])}else{this["buildFrame"](m)["addLiteral"](o[c]["nodeValue"])}}}else if(s["childNodes"]["length"]==0){this["buildFrame"](t)["addLiteral"]("")}}}s=t["element"];while(t["parent"]){var g=t;while(s==null){t=t["parent"];s=t["element"]}var y=s["childNodes"][t["lastChild"]];if(y==null||!i){t["terminateFrame"]();if(!(t=t["parent"])){break}s=t["element"];i=true}else if(y["nodeType"]!=n["nodeType"]["ELEMENT"]&&y["nodeType"]!=n["nodeType"]["TEXT"]&&y["nodeType"]!=n["nodeType"]["CDATA_SECTION"]||(y["nodeType"]==n["nodeType"]["TEXT"]||y["nodeType"]==n["nodeType"]["CDATA_SECTION"])&&s["childNodes"]["length"]!=1){t["lastChild"]++}else{t["lastChild"]++;t=this["buildFrame"](g,s["childNodes"][t["lastChild"]-1]);break}}}};this["cleanParser"]=function(){this["bnodes"]={};this["why"]=null};this["buildFrame"]=function(t,r){var i=this["frameFactory"](this,t,r);if(t){i["base"]=t["base"];i["lang"]=t["lang"]}if(r==null||r["nodeType"]==n["nodeType"]["TEXT"]||r["nodeType"]==n["nodeType"]["CDATA_SECTION"]){return i}var s=r["attributes"];var o=r["getAttributeNode"]("xml:base");if(o!=null){i["base"]=o["nodeValue"];r["removeAttribute"]("xml:base")}var u=r["getAttributeNode"]("xml:lang");if(u!=null){i["lang"]=u["nodeValue"];r["removeAttribute"]("xml:lang")}for(var a=s["length"]-1;a>=0;a--){if(s[a]["nodeName"]["substr"](0,3)=="xml"){if(s[a].name.slice(0,6)=="xmlns:"){var f=s[a].nodeValue;if(this.base)f=e.Util.uri.join(f,this.base);this.store.setPrefixForURI(s[a].name.slice(6),f)}r["removeAttributeNode"](s[a])}}return i}};e.N3Parser=function(){function t(e){return encodeURI(e)}function T(e){this.details=e}function W(e,t,n,r,i,s,o,u){return new X(e,t,n,r,i,s,o,u)}function X(e,t,n,r,i,s,o,f){if(typeof t=="undefined")t=null;if(typeof n=="undefined")n="";if(typeof r=="undefined")r=null;if(typeof i=="undefined")i="";if(typeof s=="undefined")s=null;if(typeof o=="undefined")o="";if(typeof f=="undefined")f=null;this._bindings=new a([]);this._flags=o;if(n!=""){v(n.indexOf(":")>=0,"Document URI not absolute: "+n);this._bindings[""]=n+"#"}this._store=e;if(i){e.setGenPrefix(i)}this._thisDoc=n;this.source=e.sym(n);this.lines=0;this.statementCount=0;this.startOfLine=0;this.previousLine=0;this._genPrefix=i;this.keywords=new u(["a","this","bind","has","is","of","true","false"]);this.keywordsSet=0;this._anonymousNodes=new a([]);this._variables=new a([]);this._parentVariables=new a([]);this._reason=f;this._reason2=null;if(b){this._reason2=why_BecauseOfData(e.sym(n),this._reason)}if(r){this._baseURI=r}else{if(n){this._baseURI=n}else{this._baseURI=null}}v(!this._baseURI||this._baseURI.indexOf(":")>=0);if(!this._genPrefix){if(this._thisDoc){this._genPrefix=this._thisDoc+"#_g"}else{this._genPrefix=RDFSink_uniqueURI()}}if(t==null){if(this._thisDoc){this._formula=e.formula(n+"#_formula")}else{this._formula=e.formula()}}else{this._formula=t}this._context=this._formula;this._parentContext=null}function V(e,t,n,r,i){return new $(e,t,n,r,i)}function $(e,t,n,r,i){this._str=n.encode("utf-8");this._str=n;this._i=r;this._why=i;this.lines=t;this._uri=e}function J(e,t,n,r,i){return"Line "+(t+1)+" of <"+e+">: Bad syntax: "+i+'\nat: "'+l(n,r,r+30)+'"'}function K(e){var t="";var n=new h(e);try{while(true){var r=n.next();if(r!="\r"){var t=t+r}}}catch(i){if(i!=c){throw i}}return t}function Q(e){}var n={encode:function(e){e=e.replace(/\r\n/g,"\n");var t="";for(var n=0;n<e.length;n++){var r=e.charCodeAt(n);if(r<128){t+=String.fromCharCode(r)}else if(r>127&&r<2048){t+=String.fromCharCode(r>>6|192);t+=String.fromCharCode(r&63|128)}else{t+=String.fromCharCode(r>>12|224);t+=String.fromCharCode(r>>6&63|128);t+=String.fromCharCode(r&63|128)}}return t},decode:function(e){var t="";var n=0;while(n<e.length){var r=e.charCodeAt(n);if(r<128){t+=String.fromCharCode(r);n++}else if(r>191&&r<224){t+=String.fromCharCode((r&31)<<6|e.charCodeAt(n+1)&63);n+=2}else{t+=String.fromCharCode((r&15)<<12|(e.charCodeAt(n+1)&63)<<6|e.charCodeAt(n+2)&63);n+=3}}return t}};var r="http://www.w3.org/2000/10/swap/log#forSome";var i="http://www.w3.org/2000/10/swap/log#forAll";var s="http://www.w3.org/2000/10/swap/log#";var o=function(e){return e};var u=function(e){return e};var a=function(e){if(e.length>0)throw"missing.js: oops nnonempty dict not imp";return[]};var f=function(e){return e.length};var l=function(e,t,n){if(typeof e.slice=="undefined")throw"@@ mising.js: No .slice function for "+e+" of type "+typeof e;if(typeof n=="undefined"||n==null)return e.slice(t);return e.slice(t,n)};var c=Error("dummy error stop iteration");var h=function(e){this.last=0;this.li=e;this.next=function(){if(this.last==this.li.length)throw c;return this.li[this.last++]};return this};var p=function(e){return e.charCodeAt(0)};var d=function(e,t){return e.indexOf(t)};var v=function(e,t){if(e)return;if(t)throw"python Assertion failed: "+t;throw"(python) Assertion failed."};var m=function(e){return String.fromCharCode(e)};String.prototype.encode=function(e){if(e!="utf-8")throw"UTF8_converter: can only do utf-8";return n.encode(this)};String.prototype.decode=function(e){if(e!="utf-8")throw"UTF8_converter: can only do utf-8";return this};var g=function(t,n){return e.Util.uri.join(n,t)};var y=null;var b=0;var w=0;var E=function(e){};var S="http://www.w3.org/1999/02/22-rdf-syntax-ns#type";var x="http://www.w3.org/2002/07/owl#sameAs";var N="#";var C="http://www.w3.org/2000/10/swap/log#implies";var k="http://www.w3.org/2001/XMLSchema#integer";var L="http://www.w3.org/2001/XMLSchema#double";var A="http://www.w3.org/2001/XMLSchema#decimal";var O="http://www.w3.org/2001/XMLSchema#boolean";var M=0;var _="	\r\n !\"#$%&'()*.,+/;<=>?@[\\]^`{|}~";var D=_+":";var P="http://www.w3.org/1999/02/22-rdf-syntax-ns#";var H="#";var B=new RegExp("^[ \\t]*(#[^\\n]*)?\\r?\\n","g");var j=new RegExp("^[ \\t]*(#[^\\n]*)?$","g");var F=new RegExp("^[ \\t]*","g");var I=new RegExp("^[-+]?[0-9]+","g");var q=new RegExp("^([-+]?[0-9]+)(\\.[0-9]+)?(e[-+]?[0-9]+)?","g");var R=new RegExp("^[0-9]+","g");var U=new RegExp('[\\\\\\r\\n\\"]',"g");var z=new RegExp("^[a-zA-Z0-9]+(-[a-zA-Z0-9]+)?","g");X.prototype.here=function(e){return this._genPrefix+"_L"+this.lines+"C"+(e-this.startOfLine+1)};X.prototype.formula=function(){return this._formula};X.prototype.loadStream=function(e){return this.loadBuf(e.read())};X.prototype.loadBuf=function(e){this.startDoc();this.feed(e);return this.endDoc()};X.prototype.feed=function(e){var t=e.decode("utf-8");var n=0;while(n>=0){var r=this.skipSpace(t,n);if(r<0){return}var n=this.directiveOrStatement(t,r);if(n<0){throw J(this._thisDoc,this.lines,t,r,"expected directive or statement")}}};X.prototype.directiveOrStatement=function(e,t){var n=this.skipSpace(e,t);if(n<0){return n}var r=this.directive(e,n);if(r>=0){return this.checkDot(e,r)}var r=this.statement(e,n);if(r>=0){return this.checkDot(e,r)}return r};X.prototype.tok=function(t,n,r){var i="	\n\f\r ";if(l(n,r,r+1)=="@"){var r=r+1}else{if(e.Util.ArrayIndexOf(this.keywords,t)<0){return-1}}var s=r+f(t);if(l(n,r,s)==t&&_.indexOf(n.charAt(s))>=0){return s}else{return-1}};X.prototype.directive=function(n,r){var i=this.skipSpace(n,r);if(i<0){return i}var s=new u([]);var i=this.tok("bind",n,r);if(i>0){throw J(this._thisDoc,this.lines,n,r,"keyword bind is obsolete: use @prefix")}var i=this.tok("keywords",n,r);if(i>0){var r=this.commaSeparatedList(n,i,s,false);if(r<0){throw J(this._thisDoc,this.lines,n,r,"'@keywords' needs comma separated list of words")}this.setKeywords(l(s,null,null));if(w>80){E("Keywords ",this.keywords)}return r}var i=this.tok("forAll",n,r);if(i>0){var r=this.commaSeparatedList(n,i,s,true);if(r<0){throw J(this._thisDoc,this.lines,n,r,"Bad variable list after @forAll")}var o=new h(s);try{while(true){var a=o.next();if(e.Util.ArrayIndexOf(this._variables,a)<0||e.Util.ArrayIndexOf(this._parentVariables,a)>=0){this._variables[a]=this._context.newUniversal(a)}}}catch(f){if(f!=c){throw f}}return r}var i=this.tok("forSome",n,r);if(i>0){var r=this.commaSeparatedList(n,i,s,this.uri_ref2);if(r<0){throw J(this._thisDoc,this.lines,n,r,"Bad variable list after @forSome")}var o=new h(s);try{while(true){var a=o.next();this._context.declareExistential(a)}}catch(f){if(f!=c){throw f}}return r}var i=this.tok("prefix",n,r);if(i>=0){var p=new u([]);var r=this.qname(n,i,p);if(r<0){throw J(this._thisDoc,this.lines,n,i,"expected qname after @prefix")}var i=this.uri_ref2(n,r,p);if(i<0){throw J(this._thisDoc,this.lines,n,r,"expected <uriref> after @prefix _qname_")}var d=p[1].uri;if(this._baseURI){var d=g(this._baseURI,d)}else{v(d.indexOf(":")>=0,"With no base URI, cannot handle relative URI for NS")}v(d.indexOf(":")>=0);this._bindings[p[0][0]]=d;this.bind(p[0][0],t(d));return i}var i=this.tok("base",n,r);if(i>=0){var p=new u([]);var r=this.uri_ref2(n,i,p);if(r<0){throw J(this._thisDoc,this.lines,n,i,"expected <uri> after @base ")}var d=p[0].uri;if(this._baseURI){var d=g(this._baseURI,d)}else{throw J(this._thisDoc,this.lines,n,i,"With no previous base URI, cannot use relative URI in @base  <"+d+">")}v(d.indexOf(":")>=0);this._baseURI=d;return r}return-1};X.prototype.bind=function(e,t){if(e==""){}else{this._store.setPrefixForURI(e,t)}};X.prototype.setKeywords=function(e){if(e==null){this.keywordsSet=0}else{this.keywords=e;this.keywordsSet=1}};X.prototype.startDoc=function(){};X.prototype.endDoc=function(){return this._formula};X.prototype.makeStatement=function(e){e[0].add(e[2],e[1],e[3],this.source);this.statementCount+=1};X.prototype.statement=function(e,t){var n=new u([]);var t=this.object(e,t,n);if(t<0){return t}var r=this.property_list(e,t,n[0]);if(r<0){throw J(this._thisDoc,this.lines,e,t,"expected propertylist")}return r};X.prototype.subject=function(e,t,n){return this.item(e,t,n)};X.prototype.verb=function(e,t,n){var r=this.skipSpace(e,t);if(r<0){return r}var i=new u([]);var r=this.tok("has",e,t);if(r>=0){var t=this.prop(e,r,i);if(t<0){throw J(this._thisDoc,this.lines,e,r,"expected property after 'has'")}n.push(new o(["->",i[0]]));return t}var r=this.tok("is",e,t);if(r>=0){var t=this.prop(e,r,i);if(t<0){throw J(this._thisDoc,this.lines,e,r,"expected <property> after 'is'")}var r=this.skipSpace(e,t);if(r<0){throw J(this._thisDoc,this.lines,e,t,"End of file found, expected property after 'is'");return r}var t=r;var r=this.tok("of",e,t);if(r<0){throw J(this._thisDoc,this.lines,e,t,"expected 'of' after 'is' <prop>")}n.push(new o(["<-",i[0]]));return r}var r=this.tok("a",e,t);if(r>=0){n.push(new o(["->",this._store.sym(S)]));return r}if(l(e,t,t+2)=="<="){n.push(new o(["<-",this._store.sym(s+"implies")]));return t+2}if(l(e,t,t+1)=="="){if(l(e,t+1,t+2)==">"){n.push(new o(["->",this._store.sym(s+"implies")]));return t+2}n.push(new o(["->",this._store.sym(x)]));return t+1}if(l(e,t,t+2)==":="){n.push(new o(["->",s+"becomes"]));return t+2}var r=this.prop(e,t,i);if(r>=0){n.push(new o(["->",i[0]]));return r}if(l(e,t,t+2)==">-"||l(e,t,t+2)=="<-"){throw J(this._thisDoc,this.lines,e,r,">- ... -> syntax is obsolete.")}return-1};X.prototype.prop=function(e,t,n){return this.item(e,t,n)};X.prototype.item=function(e,t,n){return this.path(e,t,n)};X.prototype.blankNode=function(e){return this._context.bnode(e,this._reason2)};X.prototype.path=function(e,t,n){var r=this.nodeOrLiteral(e,t,n);if(r<0){return r}while("!^.".indexOf(l(e,r,r+1))>=0){var i=l(e,r,r+1);if(i=="."){var s=l(e,r+1,r+2);if(!s||D.indexOf(s)>=0&&":?<[{(".indexOf(s)<0){break}}var u=n.pop();var a=this.blankNode(this.here(r));var r=this.node(e,r+1,n);if(r<0){throw J(this._thisDoc,this.lines,e,r,"EOF found in middle of path syntax")}var f=n.pop();if(i=="^"){this.makeStatement(new o([this._context,f,a,u]))}else{this.makeStatement(new o([this._context,f,u,a]))}n.push(a)}return r};X.prototype.anonymousNode=function(e){var t=this._anonymousNodes[e];if(t){return t}var t=this._store.bnode(this._context,this._reason2);this._anonymousNodes[e]=t;return t};X.prototype.node=function(e,t,n,r){if(typeof r=="undefined")r=null;var i=r;var s=this.skipSpace(e,t);if(s<0){return s}var t=s;var p=l(e,t,t+1);if(p=="["){var d=this.here(t);var s=this.skipSpace(e,t+1);if(s<0){throw J(this._thisDoc,this.lines,e,t,"EOF after '['")}if(l(e,s,s+1)=="="){var t=s+1;var v=new u([]);var s=this.objectList(e,t,v);if(s>=0){var i=v[0];if(f(v)>1){var m=new h(v);try{while(true){var g=m.next();this.makeStatement(new o([this._context,this._store.sym(x),i,g]))}}catch(b){if(b!=c){throw b}}}var s=this.skipSpace(e,s);if(s<0){throw J(this._thisDoc,this.lines,e,t,"EOF when objectList expected after [ = ")}if(l(e,s,s+1)==";"){var s=s+1}}else{throw J(this._thisDoc,this.lines,e,t,"objectList expected after [= ")}}if(i==null){var i=this.blankNode(d)}var t=this.property_list(e,s,i);if(t<0){throw J(this._thisDoc,this.lines,e,s,"property_list expected")}var s=this.skipSpace(e,t);if(s<0){throw J(this._thisDoc,this.lines,e,t,"EOF when ']' expected after [ <propertyList>")}if(l(e,s,s+1)!="]"){throw J(this._thisDoc,this.lines,e,s,"']' expected")}n.push(i);return s+1}if(p=="{"){var w=l(e,t+1,t+2);if(w=="$"){t+=1;var s=t+1;var E=new u([]);var S=true;while(1){var t=this.skipSpace(e,s);if(t<0){throw J(this._thisDoc,this.lines,e,t,"needed '$}', found end.")}if(l(e,t,t+2)=="$}"){var s=t+2;break}if(!S){if(l(e,t,t+1)==","){t+=1}else{throw J(this._thisDoc,this.lines,e,t,"expected: ','")}}else{var S=false}var T=new u([]);var s=this.item(e,t,T);if(s<0){throw J(this._thisDoc,this.lines,e,t,"expected item in set or '$}'")}E.push(T[0])}n.push(this._store.newSet(E,this._context));return s}else{var s=t+1;var N=this._parentContext;this._parentContext=this._context;var C=this._anonymousNodes;var k=this._parentVariables;this._parentVariables=this._variables;this._anonymousNodes=new a([]);this._variables=this._variables.slice();var L=this._reason2;this._reason2=y;if(i==null){var i=this._store.formula()}this._context=i;while(1){var t=this.skipSpace(e,s);if(t<0){throw J(this._thisDoc,this.lines,e,t,"needed '}', found end.")}if(l(e,t,t+1)=="}"){var s=t+1;break}var s=this.directiveOrStatement(e,t);if(s<0){throw J(this._thisDoc,this.lines,e,t,"expected statement or '}'")}}this._anonymousNodes=C;this._variables=this._parentVariables;this._parentVariables=k;this._context=this._parentContext;this._reason2=L;this._parentContext=N;n.push(i.close());return s}}if(p=="("){var A=this._store.list;var w=l(e,t+1,t+2);if(w=="$"){var A=this._store.newSet;t+=1}var s=t+1;var E=new u([]);while(1){var t=this.skipSpace(e,s);if(t<0){throw J(this._thisDoc,this.lines,e,t,"needed ')', found end.")}if(l(e,t,t+1)==")"){var s=t+1;break}var T=new u([]);var s=this.item(e,t,T);if(s<0){throw J(this._thisDoc,this.lines,e,t,"expected item in list or ')'")}E.push(T[0])}n.push(A(E,this._context));return s}var s=this.tok("this",e,t);if(s>=0){throw J(this._thisDoc,this.lines,e,t,"Keyword 'this' was ancient N3. Now use @forSome and @forAll keywords.");n.push(this._context);return s}var s=this.tok("true",e,t);if(s>=0){n.push(true);return s}var s=this.tok("false",e,t);if(s>=0){n.push(false);return s}if(i==null){var s=this.uri_ref2(e,t,n);if(s>=0){return s}}return-1};X.prototype.property_list=function(e,t,n){while(1){var r=this.skipSpace(e,t);if(r<0){throw J(this._thisDoc,this.lines,e,t,"EOF found when expected verb in property list");return r}if(l(e,r,r+2)==":-"){var t=r+2;var i=new u([]);var r=this.node(e,t,i,n);if(r<0){throw J(this._thisDoc,this.lines,e,t,"bad {} or () or [] node after :- ")}var t=r;continue}var t=r;var s=new u([]);var r=this.verb(e,t,s);if(r<=0){return t}var a=new u([]);var t=this.objectList(e,r,a);if(t<0){throw J(this._thisDoc,this.lines,e,r,"objectList expected")}var f=new h(a);try{while(true){var p=f.next();var d=s[0];var v=d[0];var m=d[1];if(v=="->"){this.makeStatement(new o([this._context,m,n,p]))}else{this.makeStatement(new o([this._context,m,p,n]))}}}catch(g){if(g!=c){throw g}}var r=this.skipSpace(e,t);if(r<0){throw J(this._thisDoc,this.lines,e,r,"EOF found in list of objects");return r}if(l(e,t,t+1)!=";"){return t}var t=t+1}};X.prototype.commaSeparatedList=function(e,t,n,r){var i=this.skipSpace(e,t);if(i<0){throw J(this._thisDoc,this.lines,e,i,"EOF found expecting comma sep list");return i}if(e.charAt(i)=="."){return t}if(r){var i=this.uri_ref2(e,i,n)}else{var i=this.bareWord(e,i,n)}if(i<0){return-1}while(1){var t=this.skipSpace(e,i);if(t<0){return t}var s=l(e,t,t+1);if(s!=","){if(s!="."){return-1}return t}if(r){var i=this.uri_ref2(e,t+1,n)}else{var i=this.bareWord(e,t+1,n)}if(i<0){throw J(this._thisDoc,this.lines,e,i,"bad list content");return i}}};X.prototype.objectList=function(e,t,n){var t=this.object(e,t,n);if(t<0){return-1}while(1){var r=this.skipSpace(e,t);if(r<0){throw J(this._thisDoc,this.lines,e,r,"EOF found after object");return r}if(l(e,r,r+1)!=","){return r}var t=this.object(e,r+1,n);if(t<0){return t}}};X.prototype.checkDot=function(e,t){var n=this.skipSpace(e,t);if(n<0){return n}if(l(e,n,n+1)=="."){return n+1}if(l(e,n,n+1)=="}"){return n}if(l(e,n,n+1)=="]"){return n}throw J(this._thisDoc,this.lines,e,n,"expected '.' or '}' or ']' at end of statement");return t};X.prototype.uri_ref2=function(t,n,r){var i=new u([]);var s=this.qname(t,n,i);if(s>=0){var o=i[0];var a=o[0];var c=o[1];if(a==null){v(0,"not used?");var h=this._baseURI+N}else{var h=this._bindings[a];if(!h){if(a=="_"){r.push(this.anonymousNode(c));return s}throw J(this._thisDoc,this.lines,t,n,"Prefix "+a+" not bound.")}}var p=this._store.sym(h+c);if(e.Util.ArrayIndexOf(this._variables,p)>=0){r.push(this._variables[p])}else{r.push(p)}return s}var n=this.skipSpace(t,n);if(n<0){return-1}if(t.charAt(n)=="?"){var d=new u([]);var s=this.variable(t,n,d);if(s>0){r.push(d[0]);return s}return-1}else if(t.charAt(n)=="<"){var n=n+1;var m=n;while(n<f(t)){if(t.charAt(n)==">"){var y=l(t,m,n);if(this._baseURI){var y=g(this._baseURI,y)}else{v(y.indexOf(":")>=0,"With no base URI, cannot deal with relative URIs")}if(l(t,n-1,n)=="#"&&!(l(y,-1,null)=="#")){var y=y+"#"}var p=this._store.sym(y);if(e.Util.ArrayIndexOf(this._variables,p)>=0){r.push(this._variables[p])}else{r.push(p)}return n+1}var n=n+1}throw J(this._thisDoc,this.lines,t,s,"unterminated URI reference")}else if(this.keywordsSet){var d=new u([]);var s=this.bareWord(t,n,d);if(s<0){return-1}if(e.Util.ArrayIndexOf(this.keywords,d[0])>=0){throw J(this._thisDoc,this.lines,t,n,'Keyword "'+d[0]+'" not allowed here.')}r.push(this._store.sym(this._bindings[""]+d[0]));return s}else{return-1}};X.prototype.skipSpace=function(e,t){var n=e;var r=" \n\r	\f            ​\u2028\u2029　";for(var i=t?t:0;i<e.length;i++){if(r.indexOf(e.charAt(i))===-1){if(e.charAt(i)==="#"){e=e.slice(t).replace(/^[^\n]*\n/,"");t=0;i=-1}else{break}}}val=n.length-e.length+i;if(val===n.length){return-1}return val};X.prototype.variable=function(e,t,n){var r=this.skipSpace(e,t);if(r<0){return-1}if(l(e,r,r+1)!="?"){return-1}var r=r+1;var t=r;if("0123456789-".indexOf(e.charAt(r))>=0){throw J(this._thisDoc,this.lines,e,r,"Varible name can't start with '"+e.charAt(r)+"s'");return-1}while(t<f(e)&&D.indexOf(e.charAt(t))<0){var t=t+1}if(this._parentContext==null){throw J(this._thisDoc,this.lines,e,r,"Can't use ?xxx syntax for variable in outermost level: "+l(e,r-1,t))}n.push(this._store.variable(l(e,r,t)));return t};X.prototype.bareWord=function(e,t,n){var r=this.skipSpace(e,t);if(r<0){return-1}var i=e.charAt(r);if("0123456789-".indexOf(i)>=0){return-1}if(D.indexOf(i)>=0){return-1}var t=r;while(t<f(e)&&D.indexOf(e.charAt(t))<0){var t=t+1}n.push(l(e,r,t));return t};X.prototype.qname=function(t,n,r){var n=this.skipSpace(t,n);if(n<0){return-1}var i=t.charAt(n);if("0123456789-+".indexOf(i)>=0){return-1}if(D.indexOf(i)<0){var s=i;var n=n+1;while(n<f(t)){var i=t.charAt(n);if(D.indexOf(i)<0){var s=s+i;var n=n+1}else{break}}}else{var s=""}if(n<f(t)&&t.charAt(n)==":"){var u=s;var n=n+1;var s="";while(n<f(t)){var i=t.charAt(n);if(D.indexOf(i)<0){var s=s+i;var n=n+1}else{break}}r.push(new o([u,s]));return n}else{if(s&&this.keywordsSet&&e.Util.ArrayIndexOf(this.keywords,s)<0){r.push(new o(["",s]));return n}return-1}};X.prototype.object=function(e,t,n){var r=this.subject(e,t,n);if(r>=0){return r}else{var r=this.skipSpace(e,t);if(r<0){return-1}else{var t=r}if(e.charAt(t)=='"'){if(l(e,t,t+3)=='"""'){var i='"""'}else{var i='"'}var t=t+f(i);var s=this.strconst(e,t,i);var r=s[0];var o=s[1];n.push(this._store.literal(o));E("New string const ",o,r);return r}else{return-1}}};X.prototype.nodeOrLiteral=function(e,t,n){var r=this.node(e,t,n);if(r>=0){return r}else{var r=this.skipSpace(e,t);if(r<0){return-1}else{var t=r}var i=e.charAt(t);if("-+0987654321".indexOf(i)>=0){q.lastIndex=0;var s=q.exec(e.slice(t));if(s==null){throw J(this._thisDoc,this.lines,e,t,"Bad number syntax")}var r=t+q.lastIndex;var o=l(e,t,r);if(o.indexOf("e")>=0){n.push(this._store.literal(parseFloat(o),undefined,this._store.sym(L)))}else if(l(e,t,r).indexOf(".")>=0){n.push(this._store.literal(parseFloat(o),undefined,this._store.sym(A)))}else{n.push(this._store.literal(parseInt(o),undefined,this._store.sym(k)))}return r}if(e.charAt(t)=='"'){if(l(e,t,t+3)=='"""'){var a='"""'}else{var a='"'}var t=t+f(a);var c=null;var h=this.strconst(e,t,a);var r=h[0];var p=h[1];var d=null;if(l(e,r,r+1)=="@"){z.lastIndex=0;var s=z.exec(e.slice(r+1));if(s==null){throw J(this._thisDoc,startline,e,t,"Bad language code syntax on string literal, after @")}var t=z.lastIndex+r+1;var d=l(e,r+1,t);var r=t}if(l(e,r,r+2)=="^^"){var v=new u([]);var r=this.uri_ref2(e,r+2,v);var c=v[0]}n.push(this._store.literal(p,d,c));return r}else{return-1}}};X.prototype.strconst=function(e,t,n){var r=t;var i="";var s=this.lines;while(r<f(e)){var t=r+f(n);if(l(e,r,t)==n){return new o([t,i])}if(e.charAt(r)=='"'){var i=i+'"';var r=r+1;continue}U.lastIndex=0;var u=U.exec(e.slice(r));if(!u){throw J(this._thisDoc,s,e,r,"Closing quote missing in string at ^ in "+l(e,r-20,r)+"^"+l(e,r,r+20))}var t=r+U.lastIndex-1;var i=i+l(e,r,t);var a=e.charAt(t);if(a=='"'){var r=t;continue}else if(a=="\r"){var r=t+1;continue}else if(a=="\n"){if(n=='"'){throw J(this._thisDoc,s,e,t,"newline found in string literal")}this.lines=this.lines+1;var i=i+a;var r=t+1;this.previousLine=this.startOfLine;this.startOfLine=r}else if(a=="\\"){var r=t+1;var a=l(e,r,r+1);if(!a){throw J(this._thisDoc,s,e,t,"unterminated string literal (2)")}var c=d('abfrtvn\\"',a);if(c>=0){var h='a\b\f\r	\n\\"'.charAt(c);var i=i+h;var r=r+1}else if(a=="u"){var p=this.uEscape(e,r+1,s);var r=p[0];var a=p[1];var i=i+a}else if(a=="U"){var p=this.UEscape(e,r+1,s);var r=p[0];var a=p[1];var i=i+a}else{throw J(this._thisDoc,this.lines,e,t,"bad escape")}}}throw J(this._thisDoc,this.lines,e,t,"unterminated string literal")};X.prototype.uEscape=function(e,t,n){var r=t;var i=0;var s=0;while(i<4){var u=l(e,r,r+1);var a=u.toLowerCase();var r=r+1;if(a==""){throw J(this._thisDoc,n,e,t,"unterminated string literal(3)")}var f=d("0123456789abcdef",a);if(f<0){throw J(this._thisDoc,n,e,t,"bad string literal hex escape")}var s=s*16+f;var i=i+1}var c=String.fromCharCode(s);return new o([r,c])};X.prototype.UEscape=function(e,t,n){var r=t;var i=0;var s="\\U";while(i<8){var u=l(e,r,r+1);var a=u.toLowerCase();var r=r+1;if(a==""){throw J(this._thisDoc,n,e,t,"unterminated string literal(3)")}var f=d("0123456789abcdef",a);if(f<0){throw J(this._thisDoc,n,e,t,"bad string literal hex escape")}var s=s+a;var i=i+1}var c=m("0x"+l(s,2,10)-0);return new o([r,c])};$.prototype.toString=function(){var e=this._str;var t=this._i;var n=0;if(t>60){var r="...";var n=t-60}else{var r=""}if(f(e)-t>60){var i="..."}else{var i=""}return'Line %i of <%s>: Bad syntax (%s) at ^ in:\n"%s%s^%s%s"'%new o([this.lines+1,this._uri,this._why,r,l(e,n,t),l(e,t,t+60),i])};return W}();e.IndexedFormula=function(){var t="http://www.w3.org/2002/07/owl#";e.Literal.prototype.hashString=e.Literal.prototype.toNT;e.Symbol.prototype.hashString=e.Symbol.prototype.toNT;e.BlankNode.prototype.hashString=e.BlankNode.prototype.toNT;e.Collection.prototype.hashString=e.Collection.prototype.toNT;e.IndexedFormula=function(n){function r(e,t,n,r,i){if(e.typeCallback!=undefined)e.typeCallback(e,r,i);var s=e.classActions[r.hashString()];var o=false;if(s){for(var u=0;u<s.length;u++){o=o||s[u](e,t,n,r,i)}}return o}function i(e,t,n,r){var i=e.any(undefined,n,r);if(i==undefined)return false;e.equate(i,t);return true}function s(e,t,n,r){var i=e.any(t,n,undefined);if(i==undefined)return false;e.equate(i,r);return true}this.statements=[];this.optional=[];this.propertyActions=[];this.classActions=[];this.redirections=[];this.aliases=[];this.HTTPRedirects=[];this.subjectIndex=[];this.predicateIndex=[];this.objectIndex=[];this.whyIndex=[];this.index=[this.subjectIndex,this.predicateIndex,this.objectIndex,this.whyIndex];this.namespaces={};if(n===undefined)n=["sameAs","InverseFunctionalProperty","FunctionalProperty"];this.propertyActions["<http://www.w3.org/1999/02/22-rdf-syntax-ns#type>"]=[r];if(e.Util.ArrayIndexOf(n,"sameAs")>=0)this.propertyActions["<http://www.w3.org/2002/07/owl#sameAs>"]=[function(e,t,n,r,i){e.equate(t,r);return true}];if(e.Util.ArrayIndexOf(n,"InverseFunctionalProperty")>=0)this.classActions["<"+t+"InverseFunctionalProperty>"]=[function(e,t,n,r,s){return e.newPropertyAction(t,i)}];if(e.Util.ArrayIndexOf(n,"FunctionalProperty")>=0)this.classActions["<"+t+"FunctionalProperty>"]=[function(e,t,n,r,i){return e.newPropertyAction(t,s)}]};e.IndexedFormula.prototype=new e.Formula;e.IndexedFormula.prototype.constructor=e.IndexedFormula;e.IndexedFormula.SuperClass=e.Formula;e.IndexedFormula.prototype.newPropertyAction=function(t,n){var r=t.hashString();if(this.propertyActions[r]==undefined)this.propertyActions[r]=[];this.propertyActions[r].push(n);var i=this.statementsMatching(undefined,t,undefined);done=false;for(var s=0;s<i.length;s++){done=done||n(this,i[s].subject,t,i[s].object)}return done};e.IndexedFormula.prototype.setPrefixForURI=function(e,t){if(e=="tab"&&this.namespaces["tab"]){return}this.namespaces[e]=t};e.IndexedFormula.prototype.register=function(e,t){this.namespaces[e]=t};e.IndexedFormula.prototype.equate=function(e,t){e=this.canon(e);t=this.canon(t);var n=e.compareTerm(t);if(!n)return true;var r,i;if(n<0){return this.replaceWith(t,e)}else{return this.replaceWith(e,t)}};e.IndexedFormula.prototype.replaceWith=function(e,t){var n=e.hashString();var r=t.hashString();var i=function(e){var t=e[n];if(t==undefined)return;var i=e[r];if(i==undefined){e[r]=t}else{e[r]=t.concat(i)}delete e[n]};for(var s=0;s<4;s++){i(this.index[s])}this.redirections[n]=t;if(e.uri){if(this.aliases[r]==undefined)this.aliases[r]=[];this.aliases[r].push(e);if(this.aliases[n]){for(var s=0;s<this.aliases[n].length;s++){this.redirections[this.aliases[n][s].hashString()]=t;this.aliases[r].push(this.aliases[n][s])}}this.add(t,this.sym("http://www.w3.org/2007/ont/link#uri"),e.uri);if(this.sf){this.sf.nowKnownAs(e,t)}}i(this.classActions);i(this.propertyActions);return true};e.IndexedFormula.prototype.canon=function(e){if(e==undefined)return e;var t=this.redirections[e.hashString()];if(t==undefined)return e;return t};e.IndexedFormula.prototype.sameThings=function(e,t){if(e.sameTerm(t))return true;var n=this.canon(e);if(n==undefined)return false;var r=this.canon(t);if(r==undefined)return false;return n.uri==r.uri};e.IndexedFormula.prototype.uris=function(e){var t=this.canon(e);var n=this.aliases[t.hashString()];if(!t.uri)return[];var r=[t.uri];if(n!=undefined){for(var i=0;i<n.length;i++){r.push(n[i].uri)}}return r};e.IndexedFormula.prototype.add=function(t,n,r,i){var s,o;if(i==undefined)i=this.fetcher?this.fetcher.appNode:this.sym("chrome:theSession");t=e.term(t);n=e.term(n);r=e.term(r);i=e.term(i);var u=[this.canon(t).hashString(),this.canon(n).hashString(),this.canon(r).hashString(),this.canon(i).hashString()];if(this.predicateCallback!=undefined)this.predicateCallback(this,n,i);var s=this.propertyActions[u[1]];var a=false;if(s){for(var f=0;f<s.length;f++){a=a||s[f](this,t,n,r,i)}}var o=new e.Statement(t,n,r,i);for(var f=0;f<4;f++){var l=this.index[f];var c=u[f];if(l[c]==undefined)l[c]=[];l[c].push(o)}this.statements.push(o);return o};e.IndexedFormula.prototype.mentionsURI=function(e){var t="<"+e+">";return!!this.subjectIndex[t]||!!this.objectIndex[t]||!!this.predicateIndex[t]};e.IndexedFormula.prototype.nextSymbol=function(e){for(var t=0;;t++){var n=e.uri+"#n"+t;if(!this.mentionsURI(n))return this.sym(n)}};e.IndexedFormula.prototype.anyStatementMatching=function(e,t,n,r){var i=this.statementsMatching(e,t,n,r,true);if(!i||i==[])return undefined;return i[0]};e.IndexedFormula.prototype.statementsMatching=function(t,n,r,i,s){var o=[t,n,r,i];var u=[];var a=[];var f=[];var l=[];for(var c=0;c<4;c++){u[c]=this.canon(e.term(o[c]));if(u[c]==undefined){f.push(c)}else{l.push(c);a[c]=u[c].hashString()}}if(l.length==0){return this.statements}if(l.length==1){var c=l[0];var h=this.index[c][a[c]];if(h&&s){if(h.length>1)h=h.slice(0,1)}return h==undefined?[]:h}var p=1e10;var d;for(var v=0;v<l.length;v++){var c=l[v];var h=this.index[c][a[c]];if(h==undefined)return[];if(h.length<p){p=h.length;d=v}}var m=l[d];var g=this.index[m][a[m]];var y=l.slice(0,d).concat(l.slice(d+1));var b=[];var w=["subject","predicate","object","why"];for(var E=0;E<g.length;E++){var S=g[E];for(var v=0;v<y.length;v++){var c=y[v];if(!this.canon(S[w[c]]).sameTerm(u[c])){S=null;break}}if(S!=null)b.push(S)}if(s){if(b.length>1)b=b.slice(0,1)}return b};e.IndexedFormula.prototype.remove=function(t){var n=[t.subject,t.predicate,t.object,t.why];for(var r=0;r<4;r++){var i=this.canon(n[r]);var s=i.hashString();if(this.index[r][s]==undefined){}else{e.Util.RDFArrayRemove(this.index[r][s],t)}}e.Util.RDFArrayRemove(this.statements,t)};e.IndexedFormula.prototype.removeMany=function(e,t,n,r,i){var s=this.statementsMatching(e,t,n,r,false);var o=[];for(var u=0;u<s.length;u++)o.push(s[u]);if(i)o=o.slice(0,i);for(var u=0;u<o.length;u++)this.remove(o[u])};e.IndexedFormula.prototype.copyTo=function(t,n,r){if(!r)r=[];var i=this.statementsMatching(t);if(e.Util.ArrayIndexOf(r,"two-direction")!=-1)i.concat(this.statementsMatching(undefined,undefined,t));for(var s=0;s<i.length;s++){var o=i[s];switch(o.object.termType){case"symbol":this.add(n,o.predicate,o.object);break;case"literal":case"bnode":case"collection":this.add(n,o.predicate,o.object.copy(this))}if(e.Util.ArrayIndexOf(r,"delete")!=-1)this.remove(o)}};e.Literal.prototype.copy=function(){return new e.Literal(this.value,this.lang,this.datatype)};e.BlankNode.prototype.copy=function(t){var n=new e.BlankNode;t.copyTo(this,n);return n};e.IndexedFormula.prototype.newUniversal=function(e){var t=this.sym(e);if(!this._universalVariables)this._universalVariables=[];this._universalVariables.push(t);return t};e.IndexedFormula.prototype.newExistential=function(e){if(!e)return this.bnode();var t=this.sym(e);return this.declareExistential(t)};e.IndexedFormula.prototype.declareExistential=function(e){if(!this._existentialVariables)this._existentialVariables=[];this._existentialVariables.push(e);return e};e.IndexedFormula.prototype.formula=function(t){return new e.IndexedFormula(t)};e.IndexedFormula.prototype.close=function(){return this};e.IndexedFormula.prototype.hashString=e.IndexedFormula.prototype.toNT;return e.IndexedFormula}();e.Query=function(t,n){this.pat=new e.IndexedFormula;this.vars=[];this.name=t;this.id=n};e.QuerySource=function(){this.queries=[];this.listeners=[];this.addQuery=function(e){var t;if(e.name==null||e.name=="")e.name="Query #"+(this.queries.length+1);e.id=this.queries.length;this.queries.push(e);for(t=0;t<this.listeners.length;t++){if(this.listeners[t]!=null)this.listeners[t].addQuery(e)}};this.removeQuery=function(e){var t;for(t=0;t<this.listeners.length;t++){if(this.listeners[t]!=null)this.listeners[t].removeQuery(e)}if(this.queries[e.id]!=null)delete this.queries[e.id]};this.addListener=function(e){var t;this.listeners.push(e);for(t=0;t<this.queries.length;t++){if(this.queries[t]!=null)e.addQuery(this.queries[t])}};this.removeListener=function(e){var t;for(t=0;t<this.queries.length;t++){if(this.queries[t]!=null)e.removeQuery(this.queries[t])}for(t=0;t<this.listeners.length;t++){if(this.listeners[t]===e){delete this.listeners[t]}}}};e.Variable.prototype.isVar=1;e.BlankNode.prototype.isVar=1;e.BlankNode.prototype.isBlank=1;e.Symbol.prototype.isVar=0;e.Literal.prototype.isVar=0;e.Formula.prototype.isVar=0;e.Collection.prototype.isVar=0;e.IndexedFormula.prototype.query=function(t,n,r,s){function u(e){var t="Bindings: ";var n,r=e.length;for(n=0;n<r;n++){t+=a(e[n][0])+";\n	"}return t}function a(e){var t="",n;for(n in e){t+="    "+n+" -> "+e[n]}return t}function f(e,t,n,r){var i=n[e];if(typeof i=="undefined"){if(e.isVar){var s=[];s[e]=t;return[[s,null]]}i=e}if(!i.complexType){if(r.redirections[i])i=r.redirections[i];if(r.redirections[t])t=r.redirections[t];if(i.sameTerm(t))return[[[],null]];return[]}if(e instanceof Array){if(!(t instanceof Array))return[];return l(e,t,n)}throw"query.js: oops - code not written yet";return undefined}function l(e,t,n,r){if(e.length!=t.length)return[];if(!e.length)return[[[],null]];var i=f(e[0],t[0],n,r);if(i==[])return i;var s=[];var o,u=i.length,a,c,h,p,d,v;for(o=0;o<u;o++){a=i[o][0];var m=[];for(d in a){m[d]=a[d]}for(d in n)m[d]=n[d];var g=l(e.slice(1),t.slice(1),m,r);p=g.length;for(h=0;h<p;h++){var v=g[h][0];for(d in a)v[d]=a[d];s.push([v,null])}}return s}function c(e,t){var n=t[e];if(typeof n=="undefined")return e;return n}function h(e,t,n){t.nvars=0;t.index=null;var r,s,o=[t.subject,t.predicate,t.object],u=[e.subjectIndex,e.predicateIndex,e.objectIndex];for(i=0;i<3;i++){if(o[i].isVar&&!(o[i]in n)){t.nvars++}else{var r=c(o[i],n);if(e.redirections[r.hashString()])r=e.redirections[r.hashString()];termIndex=u[i];t.index=termIndex[r.hashString()];if(typeof t.index=="undefined"){t.index=[]}}}if(t.index==null)t.index=e.statements;return false}function p(e,t){if(e.nvars!=t.nvars)return e.nvars-t.nvars;return e.index.length-t.index.length}function v(t,r,i,s,u,f,l){e.log.debug("Match begins, Branch count now: "+l.count+" for "+l.pattern_debug);var c=null;if(typeof t.sf!="undefined"){c=t.sf}var h=r.statements;if(h.length==0){e.log.debug("FOUND MATCH WITH BINDINGS:"+a(i));if(r.optional.length==0)l.reportMatch(i);else{e.log.debug("OPTIONAL: "+r.optional);var p=new b(n,i);var g=[],y;for(y=0;y<r.optional.length;y++){g[y]=new E(p);g[y].pattern_debug=r.optional[y]}for(y=0;y<r.optional.length;y++){g[y].count=g[y].count+1;v(t,r.optional[y],i,"",u,n,g[y])}}l.count--;e.log.debug("Match ends -- success , Branch count now: "+l.count+" for "+l.pattern_debug);return}var w,S,x=h.length;if(u){var T="match"+d++;var N=function(e,n){var a=e.uri;if(a.indexOf("#")!=-1){a=a.split("#")[0]}if(c){c.addCallback("done",function(e){if(o.canon(o.sym(e)).uri!=a&&e!=o.canon(o.sym(a))){return true}v(t,r,i,s,u,f,l);return false})}u(e,n)};for(S=0;S<x;S++){w=h[S];if(w.subject in i&&i[w.subject].uri&&c&&c.getState(e.Util.uri.docpart(i[w.subject].uri))=="unrequested"){N(i[w.subject],T);return}else if(w.object in i&&i[w.object].uri&&c&&c.getState(e.Util.uri.docpart(i[w.object].uri))=="unrequested"){N(i[w.object],T);return}}}m(t,r,i,s,u,f,l);return}function m(t,n,r,i,s,o,f){var c=n.statements,d=c.length,m;for(m=0;m<d;m++){y=c[m];e.log.info("match2: item="+y+", bindingsSoFar="+a(r));h(t,y,r)}c.sort(p);var y=c[0];var b=t.formula();b.optional=n.optional;b.constraints=n.constraints;b.statements=c.slice(1);e.log.debug(i+"match2 searching "+y.index.length+" for "+y+"; bindings so far="+a(r));var w,E=y.index.length,S;for(w=0;w<E;w++){var x=y.index[w];S=l([y.subject,y.predicate,y.object],[x.subject,x.predicate,x.object],r,t);e.log.info(i+" From first: "+S.length+": "+u(S));var T,N=S.length,C,k;for(T=0;T<N;T++){var L=[];var A=S[T][0];if(!g(A,n.constraints)){e.log.debug("Branch count CS: "+f.count);continue}for(var k in A){L[k]=A[k]}for(var k in r){L[k]=r[k]}f.count++;v(t,b,L,i+"  ",s,o,f)}}f.count--;e.log.debug("Match2 ends, Branch count: "+f.count+" for "+f.pattern_debug);if(f.count==0){e.log.debug("Branch finished.");f.reportDone(f)}}function g(e,t){var n=true;for(var r in e){if(t[r]){var i=t[r].test;if(i&&!i(e[r]))n=false}}return n}function b(e,t){this.trunkBindings=t;this.originalCallback=e;this.branches=[];return this}function w(e,t){this.count=0;this.success=false;this.done=false;this.callback=e;this.onDone=t;return this}function E(e){this.count=0;this.done=false;this.results=[];this.junction=e;e.branches.push(this);return this}var o=this;e.log.info("Query:"+t.pat+", fetcher="+r+"\n");e.log.error("@@@@ query.js 4: "+e.log.error);e.log.error("@@@@ query.js 5");var d=0;if(!r){r=function(t,n){if(t==null){return}else{e.Util.AJAR_handleNewTerm(o,t,n)}}}var y=this;e.log.debug("Query on "+this.statements.length);union=function(e,t){var n={};var r;for(r in e)n[r]=e[r];for(r in t)n[r]=t[r];return n};b.prototype.checkAllDone=function(){for(var t=0;t<this.branches.length;t++)if(!this.branches[t].done)return;e.log.debug("OPTIONAL BIDNINGS ALL DONE:");this.doCallBacks(this.branches.length-1,this.trunkBindings)};b.prototype.doCallBacks=function(e,t){if(e<0)return this.originalCallback(t);for(var n=0;n<this.branches[e].results.length;n++){this.doCallBacks(e-1,union(t,this.branches[e].results[n]))}};w.prototype.reportMatch=function(e){this.callback(e);this.success=true};w.prototype.reportDone=function(t){this.done=true;e.log.info("Mandatory query branch finished.***");if(this.onDone!=undefined)this.onDone()};E.prototype.reportMatch=function(e){this.results.push(e)};E.prototype.reportDone=function(){e.log.debug("Optional branch finished - results.length = "+this.results.length);if(this.results.length==0){this.results.push({});e.log.debug("Optional branch FAILED - that's OK.")}this.done=true;this.junction.checkAllDone()};var S=new w(n,s);S.count++;setTimeout(function(){v(y,t.pat,t.pat.initBindings,"",r,n,S)},0);return};e.queryToSPARQL=function(t){function s(e){var t=l()+"SELECT ";for(i=0;i<e.vars.length;i++)t+=e.vars[i]+" ";t+="\n";return t}function o(t){var n="";var r=t.statements;for(x in r){e.log.debug("Found statement: "+r);n+=l()+r[x]+"\n"}return n}function u(e){var t="";for(r in e.constraints){var n=e.constraints[r];t+=l()+"FILTER ( "+n.describe(r)+" ) "+"\n"}return t}function a(t){var r="";for(var i=0;i<t.optional.length;i++){e.log.debug("Found optional query");r+=l()+"OPTIONAL { "+"\n";n++;r+=o(t.optional[i]);r+=u(t.optional[i]);r+=a(t.optional[i]);n--;r+=l()+"}"+"\n"}return r}function f(e){var t=l()+"WHERE \n"+"{ \n";n++;t+=o(e);t+=u(e);t+=a(e);n--;t+="}";return t}function l(){var e="";for(i=0;i<n;i++)e+="    ";return e}function c(e){return s(e)+f(e.pat)}var n=0;return c(t)};e.SPARQLToQuery=function(t,n,r){function o(e){if(s[e])return s[e];var t=r.variable(e);s[e]=t;return t}function u(e){return typeof e=="string"&&e.match(/[^ \n\t]/)}function a(e){return typeof e=="string"&&e.match(/^[\?\$]/)}function f(e){if(typeof e=="string")return e.replace(/^</,"<").replace(/>$/,">");else return e}function l(e){return typeof e=="string"&&e.match(/^<[^>]*>$/)}function c(e){return typeof e=="string"&&(e.match(/^_:/)||e.match(/^$/))}function h(e){return typeof e=="string"&&e.match(/:$/)}function p(e){return typeof e=="string"&&e.match(/^:|^[^_][^:]*:/)}function d(e){var t=e.split(":");return t[0]}function v(e){var t=e.split(":");return t[1]}function m(e){if(l(e)){return e.slice(1,e.length-1)}else return e}function g(t){var n=t.indexOf("'")==-1?null:t.indexOf("'"),i=t.indexOf('"')==-1?null:t.indexOf('"');if(!n&&!i){var s=new Array(1);s[0]=t;return s}var o=new Array(2);if(!n||i&&i<n){var u='"';var a=i}else if(!i||n&&n<i){var u="'";var a=n}else{e.log.error("SQARQL QUERY OOPS!");return o}o[0]=t.slice(0,a);var f=t.slice(a+1).indexOf(u);if(f==-1){e.log.error("SPARQL parsing error: no matching parentheses in literal "+t);return t}if(t.slice(f+a+2).match(/^\^\^/)){var l=t.slice(f+a+2).indexOf(" ");o[1]=r.literal(t.slice(a+1,a+1+f),"",r.sym(m(t.slice(a+4+f,a+2+f+l))));o=o.concat(g(t.slice(f+a+3+l)))}else if(t.slice(f+a+2).match(/^@/)){var l=t.slice(f+a+2).indexOf(" ");o[1]=r.literal(t.slice(a+1,a+1+f),t.slice(a+3+f,a+2+f+l),null);o=o.concat(g(t.slice(f+a+2+l)))}else{o[1]=r.literal(t.slice(a+1,a+1+f),"",null);e.log.info("Literal found: "+o[1]);o=o.concat(g(t.slice(f+a+2)))}return o}function b(t){var t=t.replace(/\(/g," ( ").replace(/\)/g," ) ").replace(/</g," <").replace(/>/g,"> ").replace(/{/g," { ").replace(/}/g," } ").replace(/[\t\n\r]/g," ").replace(/; /g," ; ").replace(/\. /g," . ").replace(/, /g," , ");e.log.info("New str into spaceDelimit: \n"+t);var n=[];var r=t.split(" ");for(x in r){if(u(r[x]))n=n.concat(r[x])}return n}function w(e){var t=e;for(var n=0;n<t.length;n++){if(t[n]=="a")t[n]="<http://www.w3.org/1999/02/22-rdf-syntax-ns#type>";if(t[n]=="is"&&t[n+2]=="of"){t.splice(n,1);t.splice(n+1,1);var r=t[n-1];t[n-1]=t[n+1];t[n+1]=r}}return t}function E(t){var n=[];for(var i=0;i<t.length;i++){if(typeof t[i]!="string"){n[i]=t[i];continue}t[i]=f(t[i]);if(a(t[i]))n[i]=o(t[i].slice(1));else if(c(t[i])){e.log.info(t[i]+" was identified as a bnode.");n[i]=r.bnode()}else if(l(t[i])){e.log.info(t[i]+" was identified as a symbol.");n[i]=r.sym(m(t[i]))}else if(p(t[i])){e.log.info(t[i]+" was identified as a prefixed symbol");if(I[d(t[i])])n[i]=r.sym(t[i]=I[d(t[i])]+v(t[i]));else{e.log.error("SPARQL error: "+t[i]+" with prefix "+d(t[i])+" does not have a correct prefix entry.");n[i]=t[i]}}else n[i]=t[i]}return n}function S(t){var n=g(t);var r=[];for(x in n){if(typeof n[x]=="string")r=r.concat(b(n[x]));else r=r.concat(n[x])}r=w(r);e.log.info("SPARQL Tokens: "+r);return r}function T(e,t){for(i=0;i<t.length;i++){if(typeof t[i]!="string")continue;if(t[i].toLowerCase()==e.toLowerCase())return i}return null}function N(e,t){var n=[];for(i=0;i<t.length;i++){if(typeof t[i]!="string")continue;if(t[i].toLowerCase()==e.toLowerCase())n.push(i)}return n}function C(t,n){e.log.info("SPARQL vars: "+t);for(x in t){if(a(t[x])){e.log.info("Added "+t[x]+" to query variables from SPARQL");var r=o(t[x].slice(1));n.vars.push(r);r.label=t[x].slice(1)}else e.log.warn("Incorrect SPARQL variable in SELECT: "+t[x])}}function k(t){var n=N("PREFIX",t),r=[];for(i in n){var s=t[n[i]+1],o=t[n[i]+2];if(!h(s))e.log.error("Invalid SPARQL prefix: "+s);else if(!l(o))e.log.error("Invalid SPARQL symbol: "+o);else{e.log.info("Prefix found: "+s+" -> "+o);var u=d(s),a=m(o);r[u]=a}}return r}function L(t,n,r){e.log.info("Looking for a close bracket of type "+r+" in "+t);var s=0;for(i=0;i<t.length;i++){if(t[i]==n)s++;if(t[i]==r)s--;if(s<0)return i}e.log.error("Statement had no close parenthesis in SPARQL query");return 0}function A(e){this.describe=function(t){return t+" > "+e.toNT()};this.test=function(t){if(t.value.match(/[0-9]+(\.[0-9]+)?([eE][+-]?[0-9]+)?/))return parseFloat(t.value)>parseFloat(e);else return t.toNT()>e.toNT()};return this}function O(e){this.describe=function(t){return t+" < "+e.toNT()};this.test=function(t){if(t.value.match(/[0-9]+(\.[0-9]+)?([eE][+-]?[0-9]+)?/))return parseFloat(t.value)<parseFloat(e);else return t.toNT()<e.toNT()};return this}function M(e){this.describe=function(t){return t+" = "+e.toNT()};this.test=function(t){return e.sameTerm(t)};return this}function _(e){this.describe=function(t){return"REGEXP( '"+e+"' , "+t+" )"};this.test=function(t){var n=e;var r=new RegExp(n);if(t.value)return r.test(t.value);else return false}}function D(t,n){if(t.length==3&&t[0].termType=="variable"&&(t[2].termType=="symbol"||t[2].termType=="literal")){if(t[1]=="="){e.log.debug("Constraint added: "+t);n.constraints[t[0]]=new M(t[2])}else if(t[1]==">"){e.log.debug("Constraint added: "+t);n.constraints[t[0]]=new A(t[2])}else if(t[1]=="<"){e.log.debug("Constraint added: "+t);n.constraints[t[0]]=new O(t[2])}else e.log.warn("I don't know how to handle the constraint: "+t)}else if(t.length==6&&typeof t[0]=="string"&&t[0].toLowerCase()=="regexp"&&t[1]=="("&&t[5]==")"&&t[3]==","&&t[4].termType=="variable"&&t[2].termType=="literal"){e.log.debug("Constraint added: "+t);n.constraints[t[4]]=new _(t[2].value)}}function P(t,n){e.log.debug("Optional query: "+t+" not yet implemented.");var i=r.formula();H(t,i);n.optional.push(i)}function H(t,n){var r=E(t);e.log.debug("WHERE: "+r);while(T("OPTIONAL",r)){opt=T("OPTIONAL",r);e.log.debug("OPT: "+opt+" "+r[opt]+" in "+r);if(r[opt+1]!="{")e.log.warn("Bad optional opening bracket in word "+opt);var i=L(r.slice(opt+2),"{","}");if(i==-1)e.log.error("No matching bracket in word "+opt);else{P(r.slice(opt+2,opt+2+i),n);opt=T("OPTIONAL",r);i=L(r.slice(opt+2),"{","}");r.splice(opt,i+3)}}e.log.debug("WHERE after optionals: "+r);while(T("FILTER",r)){var s=T("FILTER",r);if(r[s+1]!="(")e.log.warn("Bad filter opening bracket in word "+s);var i=L(r.slice(s+2),"(",")");if(i==-1)e.log.error("No matching bracket in word "+s);else{D(r.slice(s+2,s+2+i),n);s=T("FILTER",r);i=L(r.slice(s+2),"(",")");r.splice(s,i+3)}}e.log.debug("WHERE after filters and optionals: "+r);B(r,n)}function B(t,n){var r=new Array(1);r[0]=-1;var i=r.concat(N(".",t));var s=[];for(var o=0;o<i.length-1;o++)s[o]=t.slice(i[o]+1,i[o+1]);for(o in s){e.log.info("s+p+o "+o+" = "+s[o]);var u=s[o][0];s[o].splice(0,1);var a=r.concat(N(";",s[o]));a.push(s[o].length);var f=[];for(y=0;y<a.length-1;y++)f[y]=s[o].slice(a[y]+1,a[y+1]);for(o in f){e.log.info("p+o "+o+" = "+s[o]);var l=f[o][0];f[o].splice(0,1);var c=r.concat(N(",",f[o]));c.push(f[o].length);var h=[];for(y=0;y<c.length-1;y++)h[y]=f[o].slice(c[y]+1,c[y+1]);for(o in h){var p=h[o][0];e.log.info("Subj="+u+" Pred="+l+" Obj="+p);n.add(u,l,p)}}}}var s=[];e.log.info("SPARQL input: \n"+t);var j=new e.Query;var F=S(t);var I=k(F);if(!I["rdf"])I["rdf"]="http://www.w3.org/1999/02/22-rdf-syntax-ns#";if(!I["rdfs"])I["rdfs"]="http://www.w3.org/2000/01/rdf-schema#";var q=T("SELECT",F),R=T("WHERE",F);if(q<0||R<0||q>R){e.log.error("Invalid or nonexistent SELECT and WHERE tags in SPARQL query");return false}C(F.slice(q+1,R),j);H(F.slice(R+2,F.length-1),j.pat);if(n)return j;for(x in j.pat.statements){var U=j.pat.statements[x];if(U.subject.termType=="symbol"){if(e.sf)e.sf.lookUpThing(U.subject,"sparql:"+U.subject)}if(U.object.termType=="symbol"){if(e.sf)e.sf.lookUpThing(U.object,"sparql:"+U.object)}}return j};e.SPARQLResultsInterpreter=function(t,n,r){function i(e){return typeof e=="string"&&e.match(/^[\?\$]/)}function s(e){if(typeof e=="string")return e.replace(/^</,"<").replace(/>$/,">");else return e}function o(e){return typeof e=="string"&&e.match(/^<[^>]*>$/)}function u(e){return typeof e=="string"&&(e.match(/^_:/)||e.match(/^$/))}function a(e){return typeof e=="string"&&e.match(/:$/)}function f(e){return typeof e=="string"&&e.match(/^:|^[^_][^:]*:/)}function l(e){var t=e.split(":");return t[0]}function c(e){var t=e.split(":");return t[1]}function h(e){if(o(e)){return e.slice(1,e.length-1)}else return e}function p(t){if(!t.name.match(/^xmlns/))return false;var n=t.name.replace(/^xmlns/,"").replace(/^:/,"").replace(/ /g,"");g[n]=t.value;e.log.info("Prefix: "+n+"\nValue: "+t.value)}function d(t){if(f(t))var n=l(t),r=c(t);else var n="",r=t;if(g[n])return g[n]+r;else e.log.error("Incorrect SPARQL results - bad prefix")}function v(t){var n=t.childNodes[0];for(var r=0;r<t.childNodes.length;r++)if(t.childNodes[r].nodeType==3){n=t.childNodes[r];break}if(d(t.nodeName)==S+"uri")return kb.sym(n.nodeValue);else if(d(t.nodeName)==S+"literal")return kb.literal(n.nodeValue);else if(d(t.nodeName)==S+"unbound")return"unbound";else e.log.warn("Don't know how to handle xml binding term "+t);return false}function m(t){var r=[],i=false;for(var s=0;s<t.childNodes.length;s++){if(t.childNodes[s].nodeType!=1)continue;if(d(t.childNodes[s].nodeName)!=S+"binding"){e.log.warn("Bad binding node inside result");continue}var o=t.childNodes[s];var u=makeVar(o.getAttribute("name"));var a=null;for(var f=0;f<o.childNodes.length;f++)if(o.childNodes[f].nodeType==1){a=v(o.childNodes[f]);break}if(!a){e.log.warn("Bad binding");return false}e.log.info("var: "+u+" binding: "+a);i=true;if(a!="unbound")r[u]=a}if(i&&n)setTimeout(function(){n(r)},0);y.push(r);return}var g=[],y=[],b,w,E=t.childNodes[0],S="http://www.w3.org/2005/sparql-results#";g[""]="";if(E.nodeName!="sparql"){e.log.error("Bad SPARQL results XML");return}for(var x=0;x<E.attributes.length;x++)p(E.attributes[x]);for(var x=0;x<E.childNodes.length;x++){e.log.info("Type: "+E.childNodes[x].nodeType+"\nName: "+E.childNodes[x].nodeName+"\nValue: "+E.childNodes[x].nodeValue);if(E.childNodes[x].nodeType==1&&d(E.childNodes[x].nodeName)==S+"head")b=E.childNodes[x];else if(E.childNodes[x].nodeType==1&&d(E.childNodes[x].nodeName)==S+"results")w=E.childNodes[x]}if(!w&&!b){e.log.error("Bad SPARQL results XML");return}for(var x=0;x<b.childNodes.length;x++){if(b.childNodes[x].nodeType==1&&d(b.childNodes[x].nodeName)==S+"variable")e.log.info("Var: "+b.childNodes[x].getAttribute("name"))}for(var x=0;x<w.childNodes.length;x++){if(d(w.childNodes[x].nodeName)==S+"result"){e.log.info("Result # "+x);m(w.childNodes[x])}}if(r)r();return y};e.sparqlUpdate=function(){var t=function(e){return e.toNT().substr(0,2)=="_:"?"?"+e.toNT().substr(2):e.toNT()};var n=function(e){return t(e.subject)+" "+t(e.predicate)+" "+t(e.object)+" ."};var r=function(t){this.store=t;this.ifps={};this.fps={};this.ns={};this.ns.link=e.Namespace("http://www.w3.org/2007/ont/link#");this.ns.http=e.Namespace("http://www.w3.org/2007/ont/http#");this.ns.httph=e.Namespace("http://www.w3.org/2007/ont/httph#");this.ns.rdf=e.Namespace("http://www.w3.org/1999/02/22-rdf-syntax-ns#");this.ns.rdfs=e.Namespace("http://www.w3.org/2000/01/rdf-schema#");this.ns.rdf=e.Namespace("http://www.w3.org/1999/02/22-rdf-syntax-ns#");this.ns.owl=e.Namespace("http://www.w3.org/2002/07/owl#")};r.prototype.editable=function(t,n){if(!t)return false;if(!n)n=tabulator.kb;if(t.slice(0,8)=="file:///"){if(n.holds(n.sym(t),tabulator.ns.rdf("type"),tabulator.ns.link("MachineEditableDocument")))return"LOCALFILE";var r=n.statementsMatching(n.sym(t),undefined,undefined);tabulator.log.warn("sparql.editable: Not MachineEditableDocument file "+t+"\n");tabulator.log.warn(r.map(function(e){return e.toNT()}).join("\n"));return false}var i;var s=false;var o=n.each(undefined,this.ns.link("requestedURI"),e.Util.uri.docpart(t));for(var u=0;u<o.length;u++){i=o[u];if(i!==undefined){var a=n.any(i,this.ns.link("response"));if(i!==undefined){var f=n.each(a,this.ns.httph("ms-author-via"));if(f.length){for(var l=0;l<f.length;l++){var c=f[l].value.trim();if(c.indexOf("SPARQL")>=0)return"SPARQL";if(c.indexOf("DAV")>=0)return"DAV"}}var h=n.each(a,this.ns.http("status"));if(h.length){for(var l=0;l<h.length;l++){if(h[l]==200||h[l]==404){s=true}}}}else{tabulator.log.warn("sparql.editable: No response for "+t+"\n")}}}if(o.length==0){tabulator.log.warn("sparql.editable: No request for "+t+"\n")}else{if(s)return false}tabulator.log.warn("sparql.editable: inconclusive for "+t+"\n");return undefined};r.prototype._statement_bnodes=function(e){return[e.subject,e.predicate,e.object].filter(function(e){return e.isBlank})};r.prototype._statement_array_bnodes=function(e){var t=[];for(var n=0;n<e.length;n++)t=t.concat(this._statement_bnodes(e[n]));t.sort();bnodes2=[];for(var r=0;r<t.length;r++)if(r==0||!t[r].sameTermAs(t[r-1]))bnodes2.push(t[r]);return bnodes2};r.prototype._cache_ifps=function(){this.ifps={};var e=this.store.each(undefined,this.ns.rdf("type"),this.ns.owl("InverseFunctionalProperty"));for(var t=0;t<e.length;t++){this.ifps[e[t].uri]=true}this.fps={};var e=this.store.each(undefined,this.ns.rdf("type"),this.ns.owl("FunctionalProperty"));for(var t=0;t<e.length;t++){this.fps[e[t].uri]=true}};r.prototype._bnode_context2=function(e,t,n){var r=this.store.statementsMatching(undefined,undefined,e,t);for(var i=0;i<r.length;i++){if(this.fps[r[i].predicate.uri]){var s=r[i].subject;if(!s.isBlank)return[r[i]];if(n){var o=this._bnode_context2(s,t,n-1);if(o!=null)return o.concat([r[i]])}}}var r=this.store.statementsMatching(e,undefined,undefined,t);for(var i=0;i<r.length;i++){if(this.ifps[r[i].predicate.uri]){var s=r[i].object;if(!s.isBlank)return[r[i]];if(n){var o=this._bnode_context2(s,t,n-1);if(o!=undefined)return o.concat([r[i]])}}}return null};r.prototype._bnode_context=function(e,t){for(var n=0;n<3;n++){var r=this._bnode_context2(e,t,n);if(r!=null)return r}throw"Unable to uniquely identify bnode: "+e.toNT()};r.prototype._bnode_context=function(e){var t=[];if(e.length){if(this.store.statementsMatching(st.subject.isBlank?undefined:st.subject,st.predicate.isBlank?undefined:st.predicate,st.object.isBlank?undefined:st.object,st.why).length<=1){t=t.concat(st)}else{this._cache_ifps();for(x in e){t=t.concat(this._bnode_context(e[x],st.why))}}}return t};r.prototype._statement_context=function(e){var t=this._statement_bnodes(e);return this._bnode_context(t)};r.prototype._context_where=function(e){return e==undefined||e.length==0?"":"WHERE { "+e.map(n).join("\n")+" }\n"};r.prototype._fire=function(t,n,r){if(!t)throw"No URI given for remote editing operation: "+n;tabulator.log.info("sparql: sending update to <"+t+">\n   query="+n+"\n");var i=e.Util.XMLHTTPFactory();i.onreadystatechange=function(){if(i.readyState==4){var e=!i.status||i.status>=200&&i.status<300;if(!e)tabulator.log.error("sparql: update failed for <"+t+"> status="+i.status+", "+i.statusText+", body length="+i.responseText.length+"\n   for query: "+n);else tabulator.log.debug("sparql: update Ok for <"+t+">");r(t,e,i.responseText)}};if(!tabulator.isExtension){try{e.Util.enablePrivilege("UniversalBrowserRead")}catch(s){alert("Failed to get privileges: "+s)}}i.open("POST",t,true);i.setRequestHeader("Content-type","application/sparql-query");i.send(n)};r.prototype.update_statement=function(e){if(e&&e.why==undefined)return;var r=this;var i=this._statement_context(e);return{statement:e?[e.subject,e.predicate,e.object,e.why]:undefined,statementNT:e?n(e):undefined,where:r._context_where(i),set_object:function(e,n){query=this.where;query+="DELETE DATA { "+this.statementNT+" } ;\n";query+="INSERT DATA { "+t(this.statement[0])+" "+t(this.statement[1])+" "+t(e)+" "+" . }\n";r._fire(this.statement[3].uri,query,n)}}};r.prototype.insert_statement=function(e,n){var r=e instanceof Array?e[0]:e;var i=this._context_where(this._statement_context(r));if(e instanceof Array){var s="";for(var o=0;o<e.length;o++)s+=e[o]+"\n";i+="INSERT DATA { "+s+" }\n"}else{i+="INSERT DATA { "+t(e.subject)+" "+t(e.predicate)+" "+t(e.object)+" "+" . }\n"}this._fire(r.why.uri,i,n)};r.prototype.delete_statement=function(e,t){var r=this._context_where(this._statement_context(e));r+="DELETE DATA { "+n(e)+" }\n";this._fire(e instanceof Array?e[0].why.uri:e.why.uri,r,t)};r.prototype.update=function(t,r,i){var s=this.store;tabulator.log.info("update called");var o=t==undefined?[]:t instanceof e.IndexedFormula?t.statements:t instanceof Array?t:[t];var u=r==undefined?[]:r instanceof e.IndexedFormula?r.statements:r instanceof Array?r:[r];if(!(o instanceof Array))throw"Type Error "+typeof o+": "+o;if(!(u instanceof Array))throw"Type Error "+typeof u+": "+u;var a=o.length?o[0].why:u[0].why;o.map(function(e){if(!a.sameTerm(e.why))throw"sparql update: destination "+a+" inconsistent with ds "+e.why});u.map(function(e){if(!a.sameTerm(e.why))throw"sparql update: destination = "+a+" inconsistent with st.why ="+e.why});var f=this.editable(a.uri,s);if(!f)throw"Can't make changes in uneditable "+a;if(f.indexOf("SPARQL")>=0){var l=[];if(o.length)l=this._statement_array_bnodes(o);if(u.length)l=l.concat(this._statement_array_bnodes(u));var c=this._bnode_context(l);var h=this._context_where(c);var p="";if(h.length){if(o.length){p+="DELETE { ";for(var d=0;d<o.length;d++)p+=n(o[d])+"\n";p+=" }\n"}if(u.length){p+="INSERT { ";for(var d=0;d<u.length;d++)p+=n(u[d])+"\n";p+=" }\n"}p+=h}else{if(o.length){p+="DELETE DATA { ";for(var d=0;d<o.length;d++)p+=n(o[d])+"\n";p+=" } \n"}if(u.length){if(o.length)p+=" ; ";p+="INSERT DATA { ";for(var d=0;d<u.length;d++)p+=n(u[d])+"\n";p+=" }\n"}}this._fire(a.uri,p,function(e,t,n){tabulator.log.info("	 sparql: Return success="+t+" for query "+p+"\n");if(t){for(var r=0;r<o.length;r++)try{s.remove(o[r])}catch(f){i(e,false,"sparqlUpdate: Remote OK but error deleting statemmnt "+o[r]+" from local store:\n"+f)}for(var r=0;r<u.length;r++)s.add(u[r].subject,u[r].predicate,u[r].object,a)}i(e,t,n)})}else if(f.indexOf("DAV")>=0){var v;var m=s.any(a,this.ns.link("request"));if(!m)throw"No record of our HTTP GET request for document: "+a;var g=s.any(m,this.ns.link("response"));if(!g)return null;var y=s.the(g,this.ns.httph("content-type")).value;var b=s.statementsMatching(undefined,undefined,undefined,a).slice();for(var d=0;d<o.length;d++)e.Util.RDFArrayRemove(b,o[d]);for(var d=0;d<u.length;d++)b.push(u[d]);var w=e.Serializer(s);w.suggestNamespaces(s.namespaces);w.setBase(a.uri);switch(y){case"application/rdf+xml":v=w.statementsToXML(b);break;case"text/rdf+n3":case"text/n3":case"text/turtle":case"application/x-turtle":case"application/n3":v=w.statementsToN3(b);break;default:throw"Content-type "+y+" not supported for data write"}var E=s.the(g,this.ns.httph("content-location"));if(E)targetURI=Util.uri.join(E.value,targetURI);var S=Util.XMLHTTPFactory();S.onreadystatechange=function(){if(S.readyState==4){var e=!S.status||S.status>=200&&S.status<300;if(e){for(var t=0;t<o.length;t++)s.remove(o[t]);for(var t=0;t<u.length;t++)s.add(u[t].subject,u[t].predicate,u[t].object,a)}i(a.uri,e,S.responseText)}};S.open("PUT",targetURI,true);S.setRequestHeader("Content-type",y);S.send(v)}else if(f.indexOf("LOCALFILE")>=0){try{tabulator.log.info("Writing back to local file\n");var b=s.statementsMatching(undefined,undefined,undefined,a).slice();for(var d=0;d<o.length;d++)e.Util.RDFArrayRemove(b,o[d]);for(var d=0;d<u.length;d++)b.push(u[d]);var v;var w=e.Serializer(s);w.suggestNamespaces(s.namespaces);w.setBase(a.uri);var x=a.uri.lastIndexOf(".");if(x<1)throw"Rewriting file: No filename extension: "+a.uri;var T=a.uri.slice(x+1);switch(T){case"rdf":case"owl":case"xml":v=w.statementsToXML(b);break;case"n3":case"nt":case"ttl":v=w.statementsToN3(b);break;default:throw"File extension ."+T+" not supported for data write"}dump("Writing back: <<<"+v+">>>\n");var N=a.uri.slice(7);var C=Components.classes["@mozilla.org/file/local;1"].createInstance(Components.interfaces.nsILocalFile);C.initWithPath(N);if(!C.exists())throw"Rewriting file <"+a.uri+"> but it does not exist!";var k=Components.classes["@mozilla.org/network/file-output-stream;1"].createInstance(Components.interfaces.nsIFileOutputStream);k.init(C,2|8|32,438,0);k.write(v,v.length);k.close();for(var d=0;d<o.length;d++)s.remove(o[d]);for(var d=0;d<u.length;d++)s.add(u[d].subject,u[d].predicate,u[d].object,a);i(a.uri,true,"")}catch(L){i(a.uri,false,"Exception trying to write back file <"+a.uri+">\n"+tabulator.Util.stackString(L))}}else throw"Unhandled edit method: '"+f+"' for "+a};return r}();e.jsonParser=function(){return{parseJSON:function(e,t,n){var r,i,s;var o={};var u=n.sym(t);for(x in e){if(x.indexOf("_:")===0){if(o[x]){r=o[x]}else{r=n.bnode(x);o[x]=r}}else{r=n.sym(x)}var a=e[x];for(y in a){var f=a[y];i=n.sym(y);for(z in f){var l=f[z];if(l.type==="uri"){s=n.sym(l.value);n.add(r,i,s,u)}else if(l.type==="bnode"){if(o[l.value]){s=o[l.value]}else{s=n.bnode(l.value);o[l.value]=s}n.add(r,i,s,u)}else if(l.type==="literal"){var c;if(l.datatype){s=n.literal(l.value,undefined,n.sym(l.datatype))}else if(l.lang){s=n.literal(l.value,l.lang)}else{s=n.literal(l.value)}n.add(r,i,s,u)}else{throw"error: unexpected termtype: "+z.type}}}}}}}();e.Serializer=function(){function o(e){return encodeURI(e)}function u(e){var r="";for(var i=0;i<e.length;i++){t=e.charCodeAt(i);if(t>65535)r+="\\U"+("00000000"+n.toString(16)).slice(-8);else if(t>126)r+="\\u"+("0000"+n.toString(16)).slice(-4);else r+=e[i]}return r}var r=function(e){this.flags="";this.base=null;this.prefixes=[];this.keywords=["a"];this.prefixchars="abcdefghijklmnopqustuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";this.incoming=null;this.formulas=[];this.store=e};r.prototype.setBase=function(e){this.base=e};r.prototype.setFlags=function(e){this.flags=e?e:""};r.prototype.toStr=function(e){var t=e.toNT();if(e.termType=="formula"){this.formulas[t]=e}return t};r.prototype.fromStr=function(e){if(e[0]=="{"){var t=this.formulas[e];if(!t)alert("No formula object for "+e);return t}return this.store.fromNT(e)};r.prototype.suggestPrefix=function(e,t){this.prefixes[t]=e};r.prototype.suggestNamespaces=function(e){for(var t in e){this.prefixes[e[t]]=t}};r.prototype.makeUpPrefix=function(e){function i(t){if(n[t])return false;this.prefixes[e]=t;r=t;return true}var t=e;var n=[];var r;i=i.bind(this);for(var s in this.prefixes){n[this.prefixes[s]]=s}if("#/".indexOf(t[t.length-1])>=0)t=t.slice(0,-1);var o=t.lastIndexOf("/");if(o>=0)t=t.slice(o+1);var u=0;while(u<t.length)if(this.prefixchars.indexOf(t[u]))u++;else break;t=t.slice(0,u);if(t.length<6&&i(t))return r;if(i(t.slice(0,3)))return r;if(i(t.slice(0,2)))return r;if(i(t.slice(0,4)))return r;if(i(t.slice(0,1)))return r;if(i(t.slice(0,5)))return r;for(var u=0;;u++)if(i(t.slice(0,3)+u))return r};r.prototype.rootSubjects=function(e){var t=[];var n=[];var r={};for(var i=0;i<e.length;i++){var s=e[i];[s.subject,s.predicate,s.object].map(function(e){if(e.termType=="bnode"){r[e.toNT()]=true}});var o=e[i].object;if(!t.hasOwnProperty(o))t[o]=[];t[o].push(s.subject);var u=n[this.toStr(s.subject)];if(!u)u=[];u.push(s);n[this.toStr(s.subject)]=u}var a=[];for(var f in n){if(!n.hasOwnProperty(f))continue;var o=this.fromStr(f);if(o.termType!="bnode"||!t[o]||t[o].length!=1){a.push(o);continue}}this.incoming=t;var l={};for(var i=0;i<a.length;i++)l[a[i].toNT()]=true;return{roots:a,subjects:n,rootsHash:l,incoming:t}};r.prototype.toN3=function(e){return this.statementsToN3(e.statements)};r.prototype._notQNameChars="	\r\n !\"#$%&'()*.,+/;<=>?@[\\]^`{|}~";r.prototype._notNameChars=r.prototype._notQNameChars+":";r.prototype.statementsToN3=function(e){function a(e){var t=[];var n=this.rootSubjects(e);var r=n.roots;var i=[];for(var s=0;s<r.length;s++){var o=r[s];i.push(f(o,n))}return i}function f(e,t){if(e.termType=="bnode"&&!t.incoming[e])return c(e,t,true).concat(["."]);return[h(e,t)].concat([l(e,t)]).concat(["."])}function l(e,t){var n=[];var r=null;var i=t.subjects[this.toStr(e)];if(typeof i=="undefined"){throw"Cant find statements for "+e}i.sort();var s=[];for(var o=0;o<i.length;o++){var u=i[o];if(u.predicate.uri==r){s.push(",")}else{if(r){n=n.concat([s]).concat([";"]);s=[]}n.push(predMap[u.predicate.uri]?predMap[u.predicate.uri]:h(u.predicate,t))}r=u.predicate.uri;s.push(c(u.object,t))}n=n.concat([s]);return n}function c(e,t,n){if(e.termType=="bnode"&&t.subjects[this.toStr(e)]&&(n||t.rootsHash[e.toNT()]==undefined))return["["].concat(l(e,t)).concat(["]"]);return h(e,t)}function h(e,t){switch(e.termType){case"formula":var n=["{"];n=n.concat(a(e.statements));return n.concat(["}"]);case"collection":var n=["("];for(i=0;i<e.elements.length;i++){n.push([c(e.elements[i],t)])}n.push(")");return n;default:return this.atomicTermToN3(e)}}function p(){str="";if(this.defaultNamespace)str+="@prefix : <"+this.defaultNamespace+">.\n";for(var e in r){if(!r.hasOwnProperty(e))continue;str+="@prefix "+this.prefixes[e]+": <"+e+">.\n"}return str+"\n"}var t=4;var n=80;var r=[];predMap={"http://www.w3.org/2002/07/owl#sameAs":"=","http://www.w3.org/2000/10/swap/log#implies":"=>","http://www.w3.org/1999/02/22-rdf-syntax-ns#type":"a"};var s=function(e){var t="";for(var n=0;n<e;n++)t+=" ";return t};var o=function(e){var t="";for(var n=0;n<e.length;n++){var r=e[n];var i=typeof r=="string"?r:o(r);if(n!=0&&i!=","&&i!=";"&&i!=".")t+=" ";t+=i}return t};var u=function(e,r){var i="";var a=1e5;if(!r)r=0;for(var f=0;f<e.length;f++){var l=e[f];if(typeof l!="string"){var c=u(l,r+1);if(c.length<10*(n-t*r)&&c.indexOf('"""')<0){var h=o(l);if(h.length<n-t*r){l="   "+h;c=""}}if(c)a=1e4;i+=c}if(typeof l=="string"){if(l.length=="1"&&i.slice(-1)=="\n"){if(",.;".indexOf(l)>=0){i=i.slice(0,-1)+l+"\n";a+=1;continue}else if("])}".indexOf(l)>=0){i=i.slice(0,-1)+" "+l+"\n";a+=2;continue}}if(a<t*r+4){i=i.slice(0,-1)+" "+l+"\n";a+=l.length+1}else{var h=s(t*r)+l;i+=h+"\n";a=h.length}}else{}}return i};a=a.bind(this);l=l.bind(this);c=c.bind(this);h=h.bind(this);p=p.bind(this);var d=a(e);return p()+u(d,-1)};r.prototype.atomicTermToN3=function(t,n){switch(t.termType){case"bnode":case"variable":return t.toNT();case"literal":if(t.datatype){switch(t.datatype.uri){case"http://www.w3.org/2001/XMLSchema#integer":return t.value.toString();case"http://www.w3.org/2001/XMLSchema#boolean":return t.value?"true":"false"}}var r=this.stringToN3(t.value);if(t.lang)r+="@"+t.lang;if(t.datatype)r+="^^"+this.termToN3(t.datatype,n);return r;case"symbol":return this.symbolToN3(t);default:throw"Internal: atomicTermToN3 cannot handle "+t+" of termType+"+t.termType;return""+t}};r.prototype.termToN3=function(t,n){switch(t.termType){case"formula":var r=["{"];r=r.concat(statementListToTree(t.statements));return r.concat(["}"]);case"collection":var r=["("];for(var i=0;i<t.elements.length;i++){r.push([objectTree(t.elements[i],n)])}r.push(")");return r;default:return this.atomicTermToN3(t)}};r.prototype.forbidden1=new RegExp(/[\\"\b\f\r\v\t\n\u0080-\uffff]/gm);r.prototype.forbidden3=new RegExp(/[\\"\b\f\r\v\u0080-\uffff]/gm);r.prototype.stringToN3=function(t,n){if(!n)n="e";var i="",s=0,o=0;var u;var a;if(t.length>20&&t.slice(-1)!='"'&&n.indexOf("n")<0&&(t.indexOf("\n")>0||t.indexOf('"')>0)){u='"""';a=r.prototype.forbidden3}else{u='"';a=r.prototype.forbidden1}for(s=0;s<t.length;){a.lastIndex=0;var f=a.exec(t.slice(s));if(f==null)break;o=s+a.lastIndex-1;i+=t.slice(s,o);var l=t[o];if(l=='"'&&u=='"""'&&t.slice(o,o+3)!='"""'){i+=l}else{var c='\b\f\r	\n\\"'.indexOf(l);if(c>=0){i+="\\"+'bfrtvn\\"'[c]}else{if(n.indexOf("e")>=0){i+="\\u"+("000"+l.charCodeAt(0).toString(16).toLowerCase()).slice(-4)}else{i+=l}}}s=o+1}return u+i+t.slice(s)+u};r.prototype.symbolToN3=function(n){var i=n.uri;var s=i.indexOf("#");if(s<0&&this.flags.indexOf("/")<0){s=i.lastIndexOf("/")}if(s>=0&&this.flags.indexOf("p")<0){var a=true;for(var f=s+1;f<i.length;f++){if(r.prototype._notNameChars.indexOf(i[f])>=0){a=false;break}}if(a){var l=i.slice(s+1);var c=i.slice(0,s+1);if(this.defaultNamespace&&this.defaultNamespace==c&&this.flags.indexOf("d")<0){if(this.flags.indexOf("k")>=0&&this.keyords.indexOf(l)<0)return l;return":"+l}var h=this.prefixes[c];if(h){return h+":"+l}if(i.slice(0,s)==this.base)return"<#"+l+">"}}if(this.flags.indexOf("r")<0&&this.base)i=e.Util.uri.refTo(this.base,i);else if(this.flags.indexOf("u")>=0)i=u(i);else i=o(i);return"<"+i+">"};r.prototype.writeStore=function(e){var t=this.store;var n=t.fetcher;var r=n&&n.appNode;if(r)e(this.statementsToN3(t.statementsMatching(undefined,undefined,undefined,r)));var i=this.store.index[3];for(s in i){var o=t.fromNT(s);if(r&&o.sameTerm(r))continue;e("\n"+this.atomicTermToN3(o)+" -> { "+this.statementsToN3(t.statementsMatching(undefined,undefined,undefined,o))+" }.\n")}};r.prototype.statementsToXML=function(t){function f(e){this.suggestPrefix("rdf","http://www.w3.org/1999/02/22-rdf-syntax-ns#");var t=this.rootSubjects(e);var n=t.roots;var r=[];for(var i=0;i<n.length;i++){root=n[i];r.push(h(root,t))}return r}function l(e){if(typeof e=="undefined")return"@@@undefined@@@@";return e.replace(/&/g,"&").replace(/</g,"<")}function c(t){return l(this.base?e.Util.uri.refTo(this.base,t.uri):t.uri)}function h(e,t){var n;if(e.termType=="bnode"){if(!t.incoming[e]){var n="<rdf:Description>"}else{var n='<rdf:Description rdf:nodeID="'+e.toNT().slice(2)+'">'}}else{var n='<rdf:Description rdf:about="'+c(e)+'">'}return[n].concat([d(e,t)]).concat(["</rdf:Description>"])}function p(e,t){var n=[];for(var r=0;r<e.elements.length;r++){n.push(h(e.elements[r],t))}return n}function d(e,t){var n=[];var r=t.subjects[this.toStr(e)];if(r==undefined)return n;r.sort();for(var i=0;i<r.length;i++){var s=r[i];switch(s.object.termType){case"bnode":if(t.rootsHash[s.object.toNT()]){n=n.concat(["<"+v(s.predicate)+' rdf:nodeID="'+s.object.toNT().slice(2)+'">',"</"+v(s.predicate)+">"])}else{n=n.concat(["<"+v(s.predicate)+' rdf:parseType="Resource">',d(s.object,t),"</"+v(s.predicate)+">"])}break;case"symbol":n=n.concat(["<"+v(s.predicate)+' rdf:resource="'+c(s.object)+'"/>']);break;case"literal":n=n.concat(["<"+v(s.predicate)+(s.object.datatype?' rdf:datatype="'+l(s.object.datatype.uri)+'"':"")+(s.object.lang?' xml:lang="'+s.object.lang+'"':"")+">"+l(s.object.value)+"</"+v(s.predicate)+">"]);break;case"collection":n=n.concat(["<"+v(s.predicate)+' rdf:parseType="Collection">',p(s.object,t),"</"+v(s.predicate)+">"]);break;default:throw"Can't serialize object of type "+s.object.termType+" into XML"}}return n}function v(e){var t=e.uri;var n=t.indexOf("#");if(n<0&&this.flags.indexOf("/")<0){n=t.lastIndexOf("/")}if(n<0)throw"Cannot make qname out of <"+t+">";var i=true;for(var o=n+1;o<t.length;o++){if(r.prototype._notNameChars.indexOf(t[o])>=0){throw'Invalid character "'+t[o]+'" cannot be in XML qname for URI: '+t}}var u=t.slice(n+1);var a=t.slice(0,n+1);if(this.defaultNamespace&&this.defaultNamespace==a&&this.flags.indexOf("d")<0){return u}var f=this.prefixes[a];if(!f)f=this.makeUpPrefix(a);s[a]=true;return f+":"+u}var n=4;var i=80;var s=[];s["http://www.w3.org/1999/02/22-rdf-syntax-ns#"]=true;var o=function(e){var t="";for(var n=0;n<e;n++)t+=" ";return t};var u=function(e){var t="";for(var n=0;n<e.length;n++){var r=e[n];var i=typeof r=="string"?r:u(r);t+=i}return t};var a=function(e,t){var r="";var s=1e5;if(!t)t=0;for(var f=0;f<e.length;f++){var l=e[f];if(typeof l!="string"){var c=a(l,t+1);if(c.length<10*(i-n*t)&&c.indexOf('"""')<0){var h=u(l);if(h.length<i-n*t){l="   "+h;c=""}}if(c)s=1e4;r+=c}if(typeof l=="string"){if(s<n*t+4){r=r.slice(0,-1)+" "+l+"\n";s+=l.length+1}else{var h=o(n*t)+l;r+=h+"\n";s=h.length}}else{}}return r};f=f.bind(this);c=c.bind(this);d=d.bind(this);v=v.bind(this);var m=f(t);var g="<rdf:RDF";if(this.defaultNamespace)g+=' xmlns="'+l(this.defaultNamespace)+'"';for(var y in s){if(!s.hasOwnProperty(y))continue;g+="\n xmlns:"+this.prefixes[y]+'="'+l(y)+'"'}g+=">";var b=[g,m,"</rdf:RDF>"];return a(b,-1)};var a=function(e){return new r(e)};return a}();var e,t,r,h=function(e,t){return function(){return e.apply(t,arguments)}},l={}.hasOwnProperty;if(typeof e==="undefined"||e===null){e={}}e.UpdatesSocket=function(){function e(e,t){this.parent=e;this.via=t;this.subscribe=h(this.subscribe,this);this.onError=h(this.onError,this);this.onMessage=h(this.onMessage,this);this.onClose=h(this.onClose,this);this.onOpen=h(this.onOpen,this);this._subscribe=h(this._subscribe,this);this._send=h(this._send,this);this.connected=false;this.pending={};this.subscribed={};this.socket=new WebSocket(t);this.socket.onopen=this.onOpen;this.socket.onclose=this.onClose;this.socket.onmessage=this.onMessage;this.socket.onerror=this.onError}e.prototype._decode=function(e){var t,n,r,i,s,o,u;i={};o=function(){var n,r,i,s;i=e.split("&");s=[];for(n=0,r=i.length;n<r;n++){t=i[n];s.push(t.split("="))}return s}();for(n in o){t=o[n];u=[decodeURIComponent(t[0]),decodeURIComponent(t[1])],r=u[0],s=u[1];if(i[r]==null){i[r]=[]}i[r].push(s)}return i};e.prototype._send=function(e,t,n){var r;r=[e,t,n].join(" ");return this.socket.send(r)};e.prototype._subscribe=function(e){this._send("sub",e,"");return this.subscribed[e]=true};e.prototype.onOpen=function(e){var t,n;this.connected=true;n=[];for(t in this.pending){delete this.pending[t];n.push(this._subscribe(t))}return n};e.prototype.onClose=function(e){var t;this.connected=false;for(t in this.subscribed){this.pending[t]=true}return this.subscribed={}};e.prototype.onMessage=function(e){var t;t=e.data.split(" ");if(t[0]==="ping"){return this.socket.send("pong "+t.slice(1).join(" "))}else if(t[0]==="pub"){return this.parent.onUpdate(t[1],this._decode(t[2]))}};e.prototype.onError=function(e){return console.log([this,"onError",arguments])};e.prototype.subscribe=function(e){if(this.connected){return this._subscribe(e)}else{return this.pending[e]=true}};return e}();e.UpdatesVia=function(){function t(e){this.fetcher=e;this.onUpdate=h(this.onUpdate,this);this.onHeaders=h(this.onHeaders,this);this.register=h(this.register,this);this.graph={};this.via={};this.fetcher.addCallback("headers",this.onHeaders)}t.prototype.register=function(t,n){if(this.via[t]==null){this.via[t]=new e.UpdatesSocket(this,t)}return this.via[t].subscribe(n)};t.prototype.onHeaders=function(e){var t,n,r;if(e.headers==null){return true}t=e.headers["etag"];r=e.headers["updates-via"];n=e.uri;if(t&&r){this.graph[n]={etag:t,via:r};this.register(r,n)}return true};t.prototype.onUpdate=function(t,n){return this.fetcher.refresh(e.sym(t))};return t}();if((typeof module!=="undefined"&&module!==null?module.exports:void 0)!=null){for(t in e){if(!l.call(e,t))continue;r=e[t];module.exports[t]=r}}e.Fetcher=function(t,n,r){this.store=t;this.thisURI="http://dig.csail.mit.edu/2005/ajar/ajaw/rdf/sources.js"+"#SourceFetcher";this.timeout=n?n:3e4;this.async=r!=null?r:true;this.appNode=this.store.bnode();this.store.fetcher=this;this.requested={};this.lookedUp={};this.handlers=[];this.mediatypes={};var i=this;var s=this.store;var o={};o.link=e.Namespace("http://www.w3.org/2007/ont/link#");o.http=e.Namespace("http://www.w3.org/2007/ont/http#");o.httph=e.Namespace("http://www.w3.org/2007/ont/httph#");o.rdf=e.Namespace("http://www.w3.org/1999/02/22-rdf-syntax-ns#");o.rdfs=e.Namespace("http://www.w3.org/2000/01/rdf-schema#");o.dc=e.Namespace("http://purl.org/dc/elements/1.1/");e.Fetcher.crossSiteProxy=function(t){if(e.Fetcher.crossSiteProxyTemplate)return e.Fetcher.crossSiteProxyTemplate.replace("{uri}",encodeURIComponent(t));else return undefined};e.Fetcher.RDFXMLHandler=function(t){if(t){this.dom=t[0]}this.recv=function(t){t.handle=function(n){var r=i.store;if(!this.dom)this.dom=e.Util.parseXML(t.responseText);var s=this.dom.documentElement;if(s.nodeName=="parsererror"){i.failFetch(t,"Badly formed XML in "+t.uri.uri);throw new Error("Badly formed XML in "+t.uri.uri)}var u=r.any(t.req,o.link("requestedURI"));if(!u){u=t.uri}else{u=r.sym(u.value)}var a=new e.RDFParser(r);i.addStatus(t.req,"parsing as RDF/XML...");a.parse(this.dom,u.uri,u);r.add(u,o.rdf("type"),o.link("RDFDocument"),i.appNode);n()}}};e.Fetcher.RDFXMLHandler.term=this.store.sym(this.thisURI+".RDFXMLHandler");e.Fetcher.RDFXMLHandler.toString=function(){return"RDFXMLHandler"};e.Fetcher.RDFXMLHandler.register=function(e){e.mediatypes["application/rdf+xml"]={}};e.Fetcher.RDFXMLHandler.pattern=new RegExp("application/rdf\\+xml");e.Fetcher.doGRDDL=function(e,t,n,r){i.requestURI("http://www.w3.org/2005/08/"+"online_xslt/xslt?"+"xslfile="+escape(n)+"&xmlfile="+escape(r),t)};e.Fetcher.XHTMLHandler=function(t){if(t){this.dom=t[0]}this.recv=function(t){t.handle=function(n){if(!this.dom){var r;if(typeof tabulator!="undefined"&&tabulator.isExtension){r=Components.classes["@mozilla.org/xmlextras/domparser;1"].getService(Components.interfaces.nsIDOMParser)}else{r=new DOMParser}this.dom=r.parseFromString(t.responseText,"application/xml")}var s=i.store;var u=this.dom.getElementsByTagName("title");if(u.length>0){s.add(t.uri,o.dc("title"),s.literal(u[0].textContent),t.uri)}var a=this.dom.getElementsByTagName("link");for(var f=a.length-1;f>=0;f--){i.linkData(t,a[f].getAttribute("rel"),a[f].getAttribute("href"))}var l=this.dom.getElementsByTagName("head")[0];if(l){var c=l.getAttribute("profile");if(c&&e.Util.uri.protocol(c)=="http"){e.Fetcher.doGRDDL(s,t.uri,"http://www.w3.org/2003/11/rdf-in-xhtml-processor",t.uri.uri)}else{}}s.add(t.uri,o.rdf("type"),o.link("WebPage"),i.appNode);if(e.rdfa&&e.rdfa.parse)e.rdfa.parse(this.dom,s,t.uri.uri)}}};e.Fetcher.XHTMLHandler.term=this.store.sym(this.thisURI+".XHTMLHandler");e.Fetcher.XHTMLHandler.toString=function(){return"XHTMLHandler"};e.Fetcher.XHTMLHandler.register=function(e){e.mediatypes["application/xhtml+xml"]={q:.3}};e.Fetcher.XHTMLHandler.pattern=new RegExp("application/xhtml");e.Fetcher.XMLHandler=function(){this.recv=function(t){t.handle=function(n){var r=i.store;var s;if(typeof tabulator!="undefined"&&tabulator.isExtension){s=Components.classes["@mozilla.org/xmlextras/domparser;1"].getService(Components.interfaces.nsIDOMParser)}else{s=new DOMParser}var o=s.parseFromString(t.responseText,"application/xml");for(var u=0;u<o.childNodes.length;u++){if(o.childNodes[u].nodeType==1){var a=o.childNodes[u].namespaceURI;if(a!=undefined&&a==a["rdf"]){i.addStatus(t.req,"Has XML root element in the RDF namespace, so assume RDF/XML.");i.switchHandler("RDFXMLHandler",t,n,[o]);return}var f=r.each(r.sym(a),r.sym("http://www.w3.org/2003/g/data-view#namespaceTransformation"));for(var l=0;l<f.length;l++){var c=f[l];e.Fetcher.doGRDDL(r,t.uri,c.uri,t.uri.uri)}break}}if(o.doctype){if(o.doctype.name=="html"&&o.doctype.publicId.match(/^-\/\/W3C\/\/DTD XHTML/)&&o.doctype.systemId.match(/http:\/\/www.w3.org\/TR\/xhtml/)){i.addStatus(t.req,"Has XHTML DOCTYPE. Switching to XHTML Handler.\n");i.switchHandler("XHTMLHandler",t,n);return}}var h=o.getElementsByTagName("html")[0];if(h){var p=h.getAttribute("xmlns");if(p&&p.match(/^http:\/\/www.w3.org\/1999\/xhtml/)){i.addStatus(t.req,"Has a default namespace for "+"XHTML. Switching to XHTMLHandler.\n");i.switchHandler("XHTMLHandler",t,n);return}}i.failFetch(t,"Unsupported dialect of XML: not RDF or XHTML namespace, etc.\n"+t.responseText.slice(0,80))}}};e.Fetcher.XMLHandler.term=this.store.sym(this.thisURI+".XMLHandler");e.Fetcher.XMLHandler.toString=function(){return"XMLHandler"};e.Fetcher.XMLHandler.register=function(e){e.mediatypes["text/xml"]={q:.2};e.mediatypes["application/xml"]={q:.2}};e.Fetcher.XMLHandler.pattern=new RegExp("(text|application)/(.*)xml");e.Fetcher.HTMLHandler=function(){this.recv=function(e){e.handle=function(t){var n=e.responseText;if(n.match(/\s*<\?xml\s+version\s*=[^<>]+\?>/)){i.addStatus(e.req,"Has an XML declaration. We'll assume "+"it's XHTML as the content-type was text/html.\n");i.switchHandler("XHTMLHandler",e,t);return}if(n.match(/.*<!DOCTYPE\s+html[^<]+-\/\/W3C\/\/DTD XHTML[^<]+http:\/\/www.w3.org\/TR\/xhtml[^<]+>/)){i.addStatus(e.req,"Has XHTML DOCTYPE. Switching to XHTMLHandler.\n");i.switchHandler("XHTMLHandler",e,t);return}if(n.match(/[^(<html)]*<html\s+[^<]*xmlns=['"]http:\/\/www.w3.org\/1999\/xhtml["'][^<]*>/)){i.addStatus(e.req,"Has default namespace for XHTML, so switching to XHTMLHandler.\n");i.switchHandler("XHTMLHandler",e,t);return}var r=(new RegExp("<title>([\\s\\S]+?)</title>","im")).exec(n);if(r){var s=i.store;s.add(e.uri,o.dc("title"),s.literal(r[1]),e.uri);s.add(e.uri,o.rdf("type"),o.link("WebPage"),i.appNode);t();return}i.failFetch(e,"Sorry, can't yet parse non-XML HTML")}}};e.Fetcher.HTMLHandler.term=this.store.sym(this.thisURI+".HTMLHandler");e.Fetcher.HTMLHandler.toString=function(){return"HTMLHandler"};e.Fetcher.HTMLHandler.register=function(e){e.mediatypes["text/html"]={q:.3}};e.Fetcher.HTMLHandler.pattern=new RegExp("text/html");e.Fetcher.TextHandler=function(){this.recv=function(e){e.handle=function(t){var n=e.responseText;if(n.match(/\s*<\?xml\s+version\s*=[^<>]+\?>/)){i.addStatus(e.req,"Warning: "+e.uri+" has an XML declaration. We'll assume "+"it's XML but its content-type wasn't XML.\n");i.switchHandler("XMLHandler",e,t);return}if(n.slice(0,500).match(/xmlns:/)){i.addStatus(e.req,"May have an XML namespace. We'll assume "+"it's XML but its content-type wasn't XML.\n");i.switchHandler("XMLHandler",e,t);return}i.addStatus(e.req,"Plain text document, no known RDF semantics.");i.doneFetch(e,[e.uri.uri])}}};e.Fetcher.TextHandler.term=this.store.sym(this.thisURI+".TextHandler");e.Fetcher.TextHandler.toString=function(){return"TextHandler"};e.Fetcher.TextHandler.register=function(e){e.mediatypes["text/plain"]={q:.1}};e.Fetcher.TextHandler.pattern=new RegExp("text/plain");e.Fetcher.N3Handler=function(){this.recv=function(t){t.handle=function(n){var r=t.responseText;var u=e.N3Parser(s,s,t.uri.uri,t.uri.uri,null,null,"",null);try{u.loadBuf(t.responseText)}catch(a){var f="Error trying to parse "+t.uri+" as Notation3:\n"+a+":\n"+a.stack;i.failFetch(t,f);return}i.addStatus(t.req,"N3 parsed: "+u.statementCount+" statements in "+u.lines+" lines.");i.store.add(t.uri,o.rdf("type"),o.link("RDFDocument"),i.appNode);args=[t.uri.uri];i.doneFetch(t,args)}}};e.Fetcher.N3Handler.term=this.store.sym(this.thisURI+".N3Handler");e.Fetcher.N3Handler.toString=function(){return"N3Handler"};e.Fetcher.N3Handler.register=function(e){e.mediatypes["text/n3"]={q:"1.0"};e.mediatypes["text/rdf+n3"]={q:1};e.mediatypes["application/x-turtle"]={q:1};e.mediatypes["text/turtle"]={q:1}};e.Fetcher.N3Handler.pattern=new RegExp("(application|text)/(x-)?(rdf\\+)?(n3|turtle)");e.Util.callbackify(this,["request","recv","headers","load","fail","refresh","retract","done"]);this.addProtocol=function(e){i.store.add(i.appNode,o.link("protocol"),i.store.literal(e),this.appNode)};this.addHandler=function(e){i.handlers.push(e);e.register(i)};this.switchHandler=function(t,n,r,s){var o=this.store;var u=null;for(var a=0;a<this.handlers.length;a++){if(""+this.handlers[a]==t){u=this.handlers[a]}}if(u==undefined){throw"web.js: switchHandler: name="+t+" , this.handlers ="+this.handlers+"\n"+"switchHandler: switching to "+u+"; sf="+i+"; typeof $rdf.Fetcher="+typeof e.Fetcher+";\n	 $rdf.Fetcher.HTMLHandler="+e.Fetcher.HTMLHandler+"\n"+"\n	sf.handlers="+i.handlers+"\n"}(new u(s)).recv(n);n.handle(r)};this.addStatus=function(e,t){var n=new Date;t="["+n.getHours()+":"+n.getMinutes()+":"+n.getSeconds()+"."+n.getMilliseconds()+"] "+t;var r=this.store;r.the(e,o.link("status")).append(r.literal(t))};this.failFetch=function(t,n){this.addStatus(t.req,n);s.add(t.uri,o.link("error"),n);this.requested[e.Util.uri.docpart(t.uri.uri)]=false;this.fireCallbacks("fail",[t.requestedURI]);t.abort();return t};this.linkData=function(t,n,r){var i=t.uri;if(!r)return;if(n=="alternate"||n=="seeAlso"||n=="meta"||n=="describedby"){var u=e.Util.uri.join2;var a=s.sym(u(r,t.uri.uri));if(a.uri!=t.uri){s.add(t.uri,o.rdfs("seeAlso"),a,t.uri)}}};this.doneFetch=function(e,t){this.addStatus(e.req,"Done.");this.requested[e.uri.uri]="done";this.fireCallbacks("done",t)};this.store.add(this.appNode,o.rdfs("label"),this.store.literal("This Session"),this.appNode);["http","https","file","chrome"].map(this.addProtocol);[e.Fetcher.RDFXMLHandler,e.Fetcher.XHTMLHandler,e.Fetcher.XMLHandler,e.Fetcher.HTMLHandler,e.Fetcher.TextHandler,e.Fetcher.N3Handler].map(this.addHandler);this.nowKnownAs=function(e,t){if(this.lookedUp[e.uri]){if(!this.lookedUp[t.uri])this.lookUpThing(t,e)}else if(this.lookedUp[t.uri]){if(!this.lookedUp[e.uri])this.lookUpThing(e,t)}};this.lookUpThing=function(t,n,r,i){var o=s.uris(t);var u=false;var a;if(typeof o!="undefined"){if(i){}for(var f=0;f<o.length;f++){this.lookedUp[o[f]]=true;this.requestURI(e.Util.uri.docpart(o[f]),n,r)}}return o.length};this.nowOrWhenFetched=function(t,n,r){var i=this.getState(t);if(i=="fetched")return r();this.addCallback("done",function(n){if(n==t||e.Fetcher.crossSiteProxy(t)==n)r();return n!=t});if(i=="unrequested")this.requestURI(t,n,false)};this.requestURI=function(t,n,r){if(t.indexOf("#")>=0){throw"requestURI should not be called with fragid: "+uri}var i=e.Util.uri.protocol(t);if(i=="tel"||i=="mailto"||i=="urn")return null;var r=!!r;var s=this.store;var u=arguments;var a=s.sym(t);if(!r&&typeof this.requested[t]!="undefined"){return null}this.fireCallbacks("request",u);this.requested[t]=true;if(n){if(n.uri){s.add(a.uri,o.link("requestedBy"),n.uri,this.appNode)}}if(n){}else{}var f=typeof jQuery!="undefined";if(!f){var l=e.Util.XMLHTTPFactory();var c=l.req=s.bnode();l.uri=a;l.requestedURI=u[0]}else{var c=s.bnode()}var h=s.collection();var p=this;var d=new Date;var v="["+d.getHours()+":"+d.getMinutes()+":"+d.getSeconds()+"] ";s.add(c,o.rdfs("label"),s.literal(v+" Request for "+t),this.appNode);s.add(c,o.link("requestedURI"),s.literal(t),this.appNode);s.add(c,o.link("status"),s.collection(),p.req);var m=function(t){return function(n){if(e.Fetcher.crossSiteProxyTemplate&&document&&document.location&&!this.proxyUsed){var r=e.Util.uri.hostpart;var i=""+document.location;var s=t.uri.uri;if(r(i)&&r(s)&&r(i)!=r(s)){this.proxyUsed=true;newURI=e.Fetcher.crossSiteProxy(s);p.addStatus(t.req,"BLOCKED -> Cross-site Proxy to <"+newURI+">");if(t.aborted)return;var u=p.store;var a=t.req;u.add(a,o.http("redirectedTo"),u.sym(newURI),a);var f=t.req=u.bnode();u.add(a,o.http("redirectedRequest"),f,t.req);var l=new Date;var c="["+l.getHours()+":"+l.getMinutes()+":"+l.getSeconds()+"] ";u.add(f,o.rdfs("label"),u.literal(c+" Request for "+newURI),this.appNode);u.add(f,o.link("status"),u.collection(),p.req);u.add(f,o.link("requestedURI"),u.literal(newURI),this.appNode);var h=u.bnode();u.add(a,o.link("response"),h);t.abort();t.aborted=true;p.addStatus(a,"done - redirected");p.requested[t.uri.uri]="redirected";var d=p.requestURI(newURI,t.uri);if(d&&d.req){u.add(t.req,u.sym("http://www.w3.org/2007/ont/link#redirectedRequest"),d.req,p.appNode);return}}}else{p.failFetch(t,"XHR Error: "+n)}}};var g=function(n){return function(){var i=function(){if(n.handleResponseDone)return;n.handleResponseDone=true;var i=null;var s=n.req;p.fireCallbacks("recv",u);var a=p.store;var f=a.bnode();a.add(s,o.link("response"),f);a.add(f,o.http("status"),a.literal(n.status),f);a.add(f,o.http("statusText"),a.literal(n.statusText),f);n.headers={};if(e.Util.uri.protocol(n.uri.uri)=="http"||e.Util.uri.protocol(n.uri.uri)=="https"){n.headers=e.Util.getHTTPHeaders(n);for(var l in n.headers){a.add(f,o.httph(l),n.headers[l].trim(),f)}}p.fireCallbacks("headers",[{uri:t,headers:n.headers}]);if(n.status>=400){if(n.responseText.length>10){a.add(f,o.http("content"),a.literal(n.responseText),f)}p.failFetch(n,"HTTP error for "+n.uri+": "+n.status+" "+n.statusText);return}var c=n.headers["content-location"];var d=function(e){var t=s;if(c){var n=a.any(t,o.link("requestedURI"));if(n!=c){a.add(a.sym(c),o.rdf("type"),e,p.appNode)}}for(;;){var r=a.any(t,o.link("requestedURI"));if(r&&r.value)a.add(a.sym(r.value),o.rdf("type"),e,p.appNode);t=a.any(undefined,a.sym("http://www.w3.org/2007/ont/link#redirectedRequest"),t);if(!t)break;var i=a.any(t,a.sym("http://www.w3.org/2007/ont/link#response"));if(!i)break;var u=a.any(i,a.sym("http://www.w3.org/2007/ont/http#status"));if(!u)break;if(u!="301"&&u!="302")break}};if(n.status==200){d(o.link("Document"));var v=n.headers["content-type"];if(v){if(v.indexOf("image/")==0)d(a.sym("http://purl.org/dc/terms/Image"))}}if(e.Util.uri.protocol(n.uri.uri)=="file"||e.Util.uri.protocol(n.uri.uri)=="chrome"){switch(n.uri.uri.split(".").pop()){case"rdf":case"owl":n.headers["content-type"]="application/rdf+xml";break;case"n3":case"nt":case"ttl":n.headers["content-type"]="text/n3";break;default:n.headers["content-type"]="text/xml"}}if(c){var m=e.Util.uri.join(n.uri.uri,c);if(!r&&m!=n.uri.uri&&p.requested[m]){p.doneFetch(n,u);n.abort();return}p.requested[m]=true}for(var g=0;g<p.handlers.length;g++){if(n.headers["content-type"]&&n.headers["content-type"].match(p.handlers[g].pattern)){i=new p.handlers[g];h.append(p.handlers[g].term);break}}var y=n.getResponseHeader("link");if(y){var b=null;var w=y.replace(/ /g,"").split(";");for(var E=1;E<w.length;E++){lr=w[E].split("=");if(lr[0]=="rel")b=lr[1]}var S=w[0];if(S.length&&S[0]=="<"&&S[S.length-1]==">"&&S.slice)S=S.slice(1,-1);if(b)p.linkData(n,b,S)}if(i){i.recv(n)}else{p.failFetch(n,"Unhandled content type: "+n.headers["content-type"]+", readyState = "+n.readyState);return}};switch(n.readyState){case 0:var s=n.uri.uri,a;if(this.crossSiteProxyTemplate&&document&&document.location){var f=e.Util.uri.hostpart;var l=""+document.location;if(f(l)&&f(s)&&f(l)!=f(s)){a=this.crossSiteProxyTemplate.replace("{uri}",encodeURIComponent(s));p.addStatus(n.req,"BLOCKED -> Cross-site Proxy to <"+a+">");if(n.aborted)return;var c=p.store;var d=n.req;c.add(d,o.http("redirectedTo"),c.sym(a),d);var v=n.req=c.bnode();c.add(d,o.http("redirectedRequest"),v,n.req);var m=new Date;var g="["+m.getHours()+":"+m.getMinutes()+":"+m.getSeconds()+"] ";c.add(v,o.rdfs("label"),c.literal(g+" Request for "+a),this.appNode);c.add(v,o.link("status"),c.collection(),p.req);c.add(v,o.link("requestedURI"),c.literal(a),this.appNode);var y=c.bnode();c.add(d,o.link("response"),y);n.abort();n.aborted=true;p.addStatus(d,"done");p.fireCallbacks("done",u);p.requested[n.uri.uri]="redirected";var b=p.requestURI(a,n.uri);if(b&&b.req)c.add(n.req,c.sym("http://www.w3.org/2007/ont/link#redirectedRequest"),b.req,p.appNode);return}}p.failFetch(n,"HTTP Blocked. (ReadyState 0) Cross-site violation for <"+t+">");break;case 3:break;case 4:i();if(n.handle){if(p.requested[n.uri.uri]==="redirected"){break}p.fireCallbacks("load",u);n.handle(function(){p.doneFetch(n,u)})}else{p.failFetch(n,"HTTP failed unusually. (no handler set) (cross-site violation? no net?) for <"+t+">")}break}}};if(!(typeof tabulator!="undefined"&&tabulator.isExtension)){try{e.Util.enablePrivilege("UniversalXPConnect UniversalBrowserRead")}catch(y){}}var b=t;if(typeof tabulator!="undefined"&&tabulator.preferences.get("offlineModeUsingLocalhost")){if(b.slice(0,7)=="http://"&&b.slice(7,17)!="localhost/")b="http://localhost/"+b.slice(7)}if(typeof jQuery!=="undefined"&&jQuery.ajax){var l=jQuery.ajax({url:t,accepts:{"*":"text/turtle,text/n3,application/rdf+xml"},processData:false,error:function(e,t,n){if(t=="timeout")p.failFetch(e,"requestTimeout");else m(e)(n)},success:function(e,t,n){g(n)()}})}else{var l=e.Util.XMLHTTPFactory();l.onerror=m(l);l.onreadystatechange=g(l);try{l.open("GET",t,this.async)}catch(w){return this.failFetch(l,"XHR open for GET failed for <"+b+">:\n	"+w)}}l.req=c;l.uri=a;l.requestedURI=t;if(typeof tabulator!="undefined"&&tabulator.isExtension&&l.channel&&(e.Util.uri.protocol(l.uri.uri)=="http"||e.Util.uri.protocol(l.uri.uri)=="https")){try{l.channel.notificationCallbacks={getInterface:function(t){if(!(typeof tabulator!="undefined"&&tabulator.isExtension)){e.Util.enablePrivilege("UniversalXPConnect")}if(t.equals(Components.interfaces.nsIChannelEventSink)){return{onChannelRedirect:function(t,r,i){if(!(typeof tabulator!="undefined"&&tabulator.isExtension)){e.Util.enablePrivilege("UniversalXPConnect")}if(l.aborted)return;var s=p.store;var a=r.URI.spec;var f=l.req;p.addStatus(l.req,"Redirected: "+l.status+" to <"+a+">");s.add(f,o.http("redirectedTo"),s.sym(a),l.req);var c=l.req=s.bnode();s.add(f,o.http("redirectedRequest"),c,l.req);var h=new Date;var d="["+h.getHours()+":"+h.getMinutes()+":"+h.getSeconds()+"] ";s.add(c,o.rdfs("label"),s.literal(d+" Request for "+a),this.appNode);s.add(c,o.link("status"),s.collection(),p.req);s.add(c,o.link("requestedURI"),s.literal(a),this.appNode);var v=s.bnode();s.add(f,o.link("response"),v);s.add(v,o.http("status"),s.literal(l.status),v);if(l.statusText)s.add(v,o.http("statusText"),s.literal(l.statusText),v);if(l.status-0!=303)s.HTTPRedirects[l.uri.uri]=a;if(l.status-0==301&&n){var m=e.Util.uri.docpart(n.uri);var g="Warning: "+l.uri+" has moved to <"+a+">.";if(n){g+=" Link in <"+m+" >should be changed";s.add(m,s.sym("http://www.w3.org/2007/ont/link#warning"),g,p.appNode)}}l.abort();l.aborted=true;p.addStatus(f,"done");p.fireCallbacks("done",u);p.requested[l.uri.uri]="redirected";var y=a.indexOf("#");if(y>=0){var g="Warning: "+l.uri+" HTTP redirects to"+a+' which should not contain a "#" sign';s.add(l.uri,s.sym("http://www.w3.org/2007/ont/link#warning"),g);a=a.slice(0,y)}var b=p.requestURI(a,l.uri);if(b&&b.req)s.add(l.req,s.sym("http://www.w3.org/2007/ont/link#redirectedRequest"),b.req,p.appNode)},asyncOnChannelRedirect:function(t,r,i,s){if(!(typeof tabulator!="undefined"&&tabulator.isExtension)){e.Util.enablePrivilege("UniversalXPConnect")}if(l.aborted)return;var a=p.store;var f=r.URI.spec;var c=l.req;p.addStatus(l.req,"Redirected: "+l.status+" to <"+f+">");a.add(c,o.http("redirectedTo"),a.sym(f),l.req);var h=l.req=a.bnode();a.add(c,o.http("redirectedRequest"),h,l.req);var d=new Date;var v="["+d.getHours()+":"+d.getMinutes()+":"+d.getSeconds()+"] ";a.add(h,o.rdfs("label"),a.literal(v+" Request for "+f),this.appNode);a.add(h,o.link("status"),a.collection(),p.req);a.add(h,o.link("requestedURI"),a.literal(f),this.appNode);var m=a.bnode();a.add(c,o.link("response"),m);a.add(m,o.http("status"),a.literal(l.status),m);if(l.statusText)a.add(m,o.http("statusText"),a.literal(l.statusText),m);if(l.status-0!=303)a.HTTPRedirects[l.uri.uri]=f;if(l.status-0==301&&n){var g=e.Util.uri.docpart(n.uri);var y="Warning: "+l.uri+" has moved to <"+f+">.";if(n){y+=" Link in <"+g+" >should be changed";a.add(g,a.sym("http://www.w3.org/2007/ont/link#warning"),y,p.appNode)}}l.abort();l.aborted=true;p.addStatus(c,"done");p.fireCallbacks("done",u);p.requested[l.uri.uri]="redirected";var b=f.indexOf("#");if(b>=0){var y="Warning: "+l.uri+" HTTP redirects to"+f+' which should not contain a "#" sign';a.add(l.uri,a.sym("http://www.w3.org/2007/ont/link#warning"),y);f=f.slice(0,b)}var w=p.requestURI(f,l.uri);if(w&&w.req)a.add(l.req,a.sym("http://www.w3.org/2007/ont/link#redirectedRequest"),w.req,p.appNode)}}}return Components.results.NS_NOINTERFACE}}}catch(E){return p.failFetch(l,"@@ Couldn't set callback for redirects: "+E)}try{var S="";for(var x in this.mediatypes){var T="";if(S!=""){S+=", "}S+=x;for(var N in this.mediatypes[x]){S+=";"+N+"="+this.mediatypes[x][N]}}l.setRequestHeader("Accept",S)}catch(E){throw"Can't set Accept header: "+E}}if(!f){try{l.send(null)}catch(w){return this.failFetch(l,"XHR send failed:"+w)}setTimeout(function(){if(l.readyState!=4&&p.isPending(l.uri.uri)){p.failFetch(l,"requestTimeout")}},this.timeout);this.addStatus(l.req,"HTTP Request sent.")}else{this.addStatus(l.req,"HTTP Request sent (using jQuery)")}if(!(typeof tabulator!="undefined"&&tabulator.isExtension)){try{e.Util.disablePrivilege("UniversalXPConnect UniversalBrowserRead")}catch(y){throw"Can't drop privilege: "+y}}return l};this.objectRefresh=function(t){var n=s.uris(t);if(typeof n!="undefined"){for(var r=0;r<n.length;r++){this.refresh(this.store.sym(e.Util.uri.docpart(n[r])))}}};this.unload=function(e){this.store.removeMany(undefined,undefined,undefined,e);delete this.requested[e.uri]};this.refresh=function(e){this.unload(e);this.fireCallbacks("refresh",arguments);this.requestURI(e.uri,undefined,true)};this.retract=function(t){this.store.removeMany(undefined,undefined,undefined,t);if(t.uri){delete this.requested[e.Util.uri.docpart(t.uri)]}this.fireCallbacks("retract",arguments)};this.getState=function(e){if(typeof this.requested[e]!="undefined"){if(this.requested[e]){if(this.isPending(e)){return"requested"}else{return"fetched"}}else{return"failed"}}else{return"unrequested"}};this.isPending=function(e){return this.requested[e]==true};var u=new e.UpdatesVia(this)};e.fetcher=function(t,n,r){return new e.Fetcher(t,n,r)};e.parse=function(n,r,i,s){try{if(s=="text/n3"||s=="text/turtle"){var o=e.N3Parser(r,r,i,i,null,null,"",null);o.loadBuf(n);return}if(s=="application/rdf+xml"){var u=new e.RDFParser(r);u.parse(e.Util.parseXML(n),i,r.sym(i));return}if(s=="application/rdfa"){if(e.rdfa&&e.rdfa.parse)e.rdfa.parse(e.Util.parseXML(n),r,i);return}}catch(a){throw"Error trying to parse <"+i+"> as "+s+":\n"+a+":\n"+a.stack}throw"Don't know how to parse "+s+" yet"};return e}()
